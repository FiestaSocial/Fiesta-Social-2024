<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración · Fiesta Social</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--c1:#0b67ff;--c1d:#0b4fb6;--ok:#059669;--err:#dc2626;--bg:#fff;--mut:#475569;--b:#e2e8f0;--sh:0 24px 60px rgba(15,23,42,.18);--r:22px}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0f172a,#1f2937 60%,#0f172a);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a;padding:32px}
  main{max-width:1100px;margin:0 auto;display:grid;gap:24px}
  .card{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:24px}
  h1,h2{margin:0 0 12px} p{margin:0 0 12px;color:var(--mut)}
  label{font-weight:600;display:block;margin:6px 0}
  input,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#f8fafc}
  .btn{border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--c1);color:#fff}.btn.primary:hover{background:var(--c1d)}
  .btn.ghost{background:#eef2ff;color:#0b67ff}
  .btn.danger{background:#fee2e2;color:#b91c1c}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width: 800px){.row{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:14px}
  .narrow{width:90px}
  .status{display:none;margin-top:10px;padding:10px;border-radius:10px}
  .status.ok{background:#dcfce7;color:#166534}.status.err{background:#fee2e2;color:#991b1b}
  pre.log{background:#0f172a;color:#e5e7eb;padding:10px;border-radius:10px;max-height:240px;overflow:auto}
</style>
</head>
<body>
<main>

  <!-- LOGIN -->
  <section class="card" id="loginCard">
    <h1>Panel de administración</h1>
    <p>Introduce la contraseña para editar la configuración (se valida contra <code>admin.passwordHash</code> del <code>config.json</code>).</p>
    <label>Contraseña</label>
    <input type="password" id="pw">
    <div style="margin-top:12px">
      <button class="btn primary" id="btnLogin">Ingresar</button>
    </div>
    <div id="loginMsg" class="status"></div>
  </section>

  <!-- EDITOR -->
  <section class="card" id="editCard" style="display:none">
    <h2>Configuración del sitio</h2>

    <div class="row">
      <div>
        <label>Título</label><input id="siteTitle">
        <label>Subtítulo</label><input id="siteSubtitle">
        <label>Descripción</label><textarea id="siteDescription"></textarea>
        <label>Imagen héroe (URL)</label><input id="heroImage">
      </div>
      <div>
        <label>URL Google Apps Script (/exec)</label><input id="reservationScriptUrl">
        <label>CSV de invitados (opcional)</label><input id="guestsSheetCsvUrl">
        <label>Capacidad por defecto</label><input id="defaultCapacity" type="number" min="1" step="1">
      </div>
    </div>

    <h3 style="margin-top:18px">Tamaños de la representación (UI)</h3>
    <div class="row">
      <div>
        <label>Tamaño de botón de mesa (px)</label><input id="uiMesaSize" type="number" class="narrow" min="24" step="1">
        <label>Tamaño de asiento (px)</label><input id="uiSeatSize" type="number" class="narrow" min="20" step="1">
      </div>
      <div>
        <label>Diámetro de mesa circular (px)</label><input id="uiTableSize" type="number" class="narrow" min="80" step="1">
        <label>Escala global de zonas (chips)</label><input id="uiZoneScale" type="number" class="narrow" min="0.6" step="0.1">
      </div>
    </div>

    <h3 style="margin-top:18px">Mesas</h3>
    <table id="tblMesas">
      <thead>
        <tr><th class="narrow">#</th><th>Etiqueta</th><th class="narrow">Cap.</th><th class="narrow">X%</th><th class="narrow">Y%</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn primary" id="addMesa">Agregar mesa</button>

    <h3 style="margin-top:24px">Zonas</h3>
    <table id="tblZones">
      <thead>
        <tr><th>ID</th><th>Etiqueta</th><th>Clases CSS</th><th class="narrow">X%</th><th class="narrow">Y%</th><th class="narrow">Tamaño</th><th></th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button class="btn primary" id="addZone">Agregar zona</button>

    <div style="margin-top:18px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn primary" id="saveLocal">Guardar (navegador)</button>
      <button class="btn ghost"   id="download">Descargar config.json</button>
      <button class="btn danger"  id="reset">Resetear</button>
      <a class="btn ghost" href="index.html">Volver al sitio</a>
    </div>

    <div id="saveMsg" class="status"></div>
  </section>

  <!-- VERIFICACIÓN -->
  <section class="card" id="verifyCard" style="display:none">
    <h2>Verificar & pruebas</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn primary" id="vPing">Probar Apps Script (ping)</button>
      <button class="btn primary" id="vDebug">Debug hoja (?debug=1)</button>
      <button class="btn primary" id="vCSV">Probar CSV</button>
      <button class="btn ghost" id="vWrite">Registrar invitado de prueba</button>
    </div>
    <div id="vMsg" class="status"></div>
    <pre id="vLog" class="log"></pre>
  </section>
</main>

<script>
let cfg=null;

const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));

async function sha256(text){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadConfig(){
  try{const local=localStorage.getItem('fiestaConfig'); if(local) return JSON.parse(local);}catch{}
  const r=await fetch('config.json?_='+Date.now()); if(!r.ok) throw new Error('Sin config.json'); return await r.json();
}

/* ====== LOGIN ====== */
$('#btnLogin').addEventListener('click', async ()=>{
  $('#loginMsg').style.display='none';
  try{
    cfg = await loadConfig();
    const hash = cfg?.admin?.passwordHash || '';
    if(!hash){ $('#loginMsg').className='status err'; $('#loginMsg').textContent='No hay passwordHash en config.json'; $('#loginMsg').style.display='block'; return; }
    const typed = await sha256($('#pw').value);
    if(typed!==hash){ $('#loginMsg').className='status err'; $('#loginMsg').textContent='Contraseña incorrecta'; $('#loginMsg').style.display='block'; return; }
    $('#loginCard').style.display='none';
    $('#editCard').style.display='block';
    $('#verifyCard').style.display='block';
    paintForms();
  }catch(e){
    $('#loginMsg').className='status err'; $('#loginMsg').textContent='Error cargando configuración'; $('#loginMsg').style.display='block';
  }
});

function paintForms(){
  $('#siteTitle').value       = cfg.siteTitle||'';
  $('#siteSubtitle').value    = cfg.siteSubtitle||'';
  $('#siteDescription').value = cfg.siteDescription||'';
  $('#heroImage').value       = cfg.heroImage||'';
  $('#reservationScri
