<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Administración · Fiesta Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --c1:#0b67ff;--c1d:#0b4fb6;--ok:#059669;--err:#dc2626;
    --bg:#fff;--mut:#475569;--b:#e2e8f0;--sh:0 24px 60px rgba(15,23,42,.18);--r:22px
  }
  *{box-sizing:border-box}
  body{
    margin:0;min-height:100vh;background:linear-gradient(135deg,#0f172a,#1f2937 60%,#0f172a);
    font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#0f172a;padding:32px;
    display:flex;justify-content:center
  }
  main{width:100%;max-width:1100px;display:grid;gap:24px}
  .card{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:24px}
  h1,h2{margin:0 0 12px} p{margin:0 0 12px;color:var(--mut)}
  label{font-weight:600;display:block;margin:6px 0}
  input,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#f8fafc}
  .btn{border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--c1);color:#fff}.btn.primary:hover{background:var(--c1d)}
  .btn.ghost{background:#eef2ff;color:#0b67ff}.btn.danger{background:#fee2e2;color:#b91c1c}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width: 800px){.row{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:14px}
  .narrow{width:90px}
  .status{display:none;margin-top:10px;padding:10px;border-radius:10px}
  .status.ok{background:#dcfce7;color:#166534}.status.err{background:#fee2e2;color:#991b1b}
  pre.log{background:#0f172a;color:#e5e7eb;padding:10px;border-radius:10px;max-height:260px;overflow:auto}
</style>
</head>
<body>
<main>

  <!-- LOGIN -->
  <section class="card" id="loginCard">
    <h1>Panel de administración</h1>
    <p>Ingresa la contraseña para editar la configuración (se valida con <code>admin.passwordHash</code> en <code>config.json</code>).</p>
    <label>Contraseña</label>
    <input type="password" id="pw" autocomplete="current-password">
    <div style="margin-top:12px"><button class="btn primary" id="btnLogin">Ingresar</button></div>
    <div id="loginMsg" class="status"></div>
  </section>

  <!-- EDITOR -->
  <section class="card" id="editCard" style="display:none">
    <h2>Configuración del sitio</h2>

    <div class="row">
      <div>
        <label>Título</label><input id="siteTitle">
        <label>Subtítulo</label><input id="siteSubtitle">
        <label>Descripción</label><textarea id="siteDescription"></textarea>
        <label>Imagen héroe (URL)</label><input id="heroImage">
      </div>
      <div>
        <label>URL Google Apps Script (/exec)</label><input id="reservationScriptUrl">
        <label>CSV de invitados (opcional)</label><input id="guestsSheetCsvUrl">
        <label>Capacidad por defecto</label><input id="defaultCapacity" type="number" min="1" step="1">
      </div>
    </div>

    <h3 style="margin-top:18px">Tamaños de la representación (UI)</h3>
    <div class="row">
      <div>
        <label>Tamaño de botón de mesa (px)</label><input id="uiMesaSize" type="number" class="narrow" min="24" step="1">
        <label>Tamaño de asiento (px)</label><input id="uiSeatSize" type="number" class="narrow" min="20" step="1">
      </div>
      <div>
        <label>Diámetro de mesa circular (px)</label><input id="uiTableSize" type="number" class="narrow" min="80" step="1">
        <label>Escala global de zonas</label><input id="uiZoneScale" type="number" class="narrow" min="0.6" step="0.1">
      </div>
    </div>

    <h3 style="margin-top:18px">Mesas</h3>
    <table id="tblMesas">
      <thead><tr><th class="narrow">#</th><th>Etiqueta</th><th class="narrow">Cap.</th><th class="narrow">X%</th><th class="narrow">Y%</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn primary" id="addMesa" style="margin-top:8px">Agregar mesa</button>

    <h3 style="margin-top:24px">Zonas</h3>
    <table id="tblZones">
      <thead><tr><th>ID</th><th>Etiqueta</th><th>Clases CSS</th><th class="narrow">X%</th><th class="narrow">Y%</th><th class="narrow">Tamaño</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <button class="btn primary" id="addZone" style="margin-top:8px">Agregar zona</button>

    <div style="margin-top:18px; display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn primary" id="saveLocal">Guardar (navegador)</button>
      <button class="btn ghost"   id="download">Descargar config.json</button>
      <button class="btn danger"  id="reset">Resetear</button>
      <a class="btn ghost" href="index.html">Volver al sitio</a>
    </div>
    <div id="saveMsg" class="status"></div>
  </section>

  <!-- VERIFICACIÓN -->
  <section class="card" id="verifyCard" style="display:none">
    <h2>Verificar & pruebas</h2>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn primary" id="vPing">Ping Apps Script</button>
      <button class="btn primary" id="vDebug">Debug (?debug=1)</button>
      <button class="btn primary" id="vCSV">Probar CSV</button>
      <button class="btn primary" id="vPost">Probar POST (text/plain)</button>
      <button class="btn ghost"   id="vWrite">Escribir fila de prueba (GET)</button>
    </div>
    <div id="vMsg" class="status"></div>
    <pre id="vLog" class="log"></pre>
  </section>

</main>

<script>
let cfg=null;
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function show(el,cls,msg){ el.className='status '+cls; el.textContent=msg; el.style.display='block'; }
async function sha256(text){ const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text)); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function loadConfig(){
  try{ const local=localStorage.getItem('fiestaConfig'); if(local) return JSON.parse(local); }catch{}
  const r=await fetch('config.json?_='+Date.now()); if(!r.ok) throw new Error('Sin config.json'); return await r.json();
}

/* Login */
$('#btnLogin').addEventListener('click', async ()=>{
  $('#loginMsg').style.display='none';
  try{
    cfg = await loadConfig();
    const hash = cfg?.admin?.passwordHash || '';
    if(!hash){ show($('#loginMsg'),'err','Falta admin.passwordHash en config.json'); return; }
    const typed = await sha256($('#pw').value);
    if(typed !== hash){ show($('#loginMsg'),'err','Contraseña incorrecta'); return; }
    $('#loginCard').style.display='none'; $('#editCard').style.display='block'; $('#verifyCard').style.display='block';
    paintForms();
  }catch{ show($('#loginMsg'),'err','No se pudo cargar configuración'); }
});

/* Pintar formularios */
function paintForms(){
  $('#siteTitle').value        = cfg.siteTitle || '';
  $('#siteSubtitle').value     = cfg.siteSubtitle || '';
  $('#siteDescription').value  = cfg.siteDescription || '';
  $('#heroImage').value        = cfg.heroImage || '';
  $('#reservationScriptUrl').value = cfg.reservationScriptUrl || '';
  $('#guestsSheetCsvUrl').value    = cfg.guestsSheetCsvUrl || '';
  $('#defaultCapacity').value      = cfg.defaultCapacity || 10;

  const ui = cfg.ui || {};
  $('#uiMesaSize').value  = ui.mesaSize  ?? 52;
  $('#uiSeatSize').value  = ui.seatSize  ?? 42;
  $('#uiTableSize').value = ui.tableSize ?? 120;
  $('#uiZoneScale').value = ui.zoneScale ?? 1;

  renderMesas(); renderZones();
}

/* Mesas */
function renderMesas(){
  const tbody=$('#tblMesas tbody'); tbody.innerHTML='';
  (cfg.mesas||[]).forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="narrow" type="number" value="${m.number||i+1}" data-f="number"></td>
      <td><input value="${m.label||`Mesa ${i+1}`}" data-f="label"></td>
      <td><input class="narrow" type="number" min="1" step="1" value="${m.capacity||cfg.defaultCapacity||10}" data-f="capacity"></td>
      <td><input class="narrow" type="number" step="0.1" min="0" max="100" value="${m.position?.x??0}" data-f="x"></td>
      <td><input class="narrow" type="number" step="0.1" min="0" max="100" value="${m.position?.y??0}" data-f="y"></td>
      <td><button class="btn danger" data-del>Eliminar</button></td>`;
    tr.querySelector('[data-del]').addEventListener('click',()=>{ cfg.mesas.splice(i,1); renderMesas(); });
    tbody.appendChild(tr);
  });
}
function collectMesas(){
  return $$('#tblMesas tbody tr').map(r=>{
    const get=f=>r.querySelector(`[data-f="${f}"]`).value;
    return {
      number: parseInt(get('number'),10)||0,
      label: (get('label')||'').trim(),
      capacity: parseInt(get('capacity'),10)||parseInt($('#defaultCapacity').value,10)||10,
      position:{ x: parseFloat(get('x'))||0, y: parseFloat(get('y'))||0 }
    };
  }).sort((a,b)=>(a.number||0)-(b.number||0));
}
$('#addMesa').addEventListener('click', ()=>{
  const ms=collectMesas(); const next=(ms.reduce((mx,m)=>Math.max(mx,m.number||0),0)||0)+1;
  ms.push({ number:next, label:`Mesa ${next}`, capacity:parseInt($('#defaultCapacity').value,10)||10, position:{x:50,y:50} });
  cfg.mesas=ms; renderMesas();
});

/* Zonas (con tamaño por zona) */
function renderZones(){
  const tbody=$('#tblZones tbody'); tbody.innerHTML='';
  (cfg.zones||[]).forEach((z,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input value="${z.id||''}" data-f="id"></td>
      <td><input value="${z.label||''}" data-f="label"></td>
      <td><input value="${z.className||''}" data-f="class"></td>
      <td><input class="narrow" type="number" step="0.1" min="0" max="100" value="${z.position?.x??0}" data-f="x"></td>
      <td><input class="narrow" type="number" step="0.1" min="0" max="100" value="${z.position?.y??0}" data-f="y"></td>
      <td><input class="narrow" type="number" step="0.1" min="0.5" value="${z.scale ?? (cfg?.ui?.zoneScale ?? 1)}" data-f="scale"></td>
      <td><button class="btn danger" data-del>Eliminar</button></td>`;
    tr.querySelector('[data-del]').addEventListener('click',()=>{ cfg.zones.splice(i,1); renderZones(); });
    tbody.appendChild(tr);
  });
}
function collectZones(){
  return $$('#tblZones tbody tr').map(r=>{
    const get=f=>r.querySelector(`[data-f="${f}"]`).value;
    return {
      id:(get('id')||'').trim(),
      label:(get('label')||'').trim(),
      className:(get('class')||'').trim(),
      position:{ x: parseFloat(get('x'))||0, y: parseFloat(get('y'))||0 },
      scale: parseFloat(get('scale')) || null
    };
  }).filter(z=>z.id && z.label);
}
$('#addZone').addEventListener('click', ()=>{
  (cfg.zones ||= []).push({ id:`zona-${Math.random().toString(36).slice(2,7)}`, label:'Nueva zona', className:'', position:{x:50,y:50}, scale: cfg?.ui?.zoneScale || 1 });
  renderZones();
});

/* Guardar / Descargar / Reset */
$('#saveLocal').addEventListener('click', ()=>{
  cfg.siteTitle        = $('#siteTitle').value.trim();
  cfg.siteSubtitle     = $('#siteSubtitle').value.trim();
  cfg.siteDescription  = $('#siteDescription').value.trim();
  cfg.heroImage        = $('#heroImage').value.trim();
  cfg.reservationScriptUrl = $('#reservationScriptUrl').value.trim();
  cfg.guestsSheetCsvUrl    = $('#guestsSheetCsvUrl').value.trim();
  cfg.defaultCapacity      = parseInt($('#defaultCapacity').value,10) || 10;

  cfg.ui = {
    mesaSize:  parseFloat($('#uiMesaSize').value)  || 52,
    seatSize:  parseFloat($('#uiSeatSize').value)  || 42,
    tableSize: parseFloat($('#uiTableSize').value) || 120,
    zoneScale: parseFloat($('#uiZoneScale').value) || 1
  };

  cfg.mesas = collectMesas();
  cfg.zones = collectZones();

  localStorage.setItem('fiestaConfig', JSON.stringify(cfg));
  show($('#saveMsg'),'ok','Guardado en este navegador. (Descarga config.json si no usas localStorage en producción).');
});
$('#download').addEventListener('click', ()=>{
  if(!cfg){ show($('#saveMsg'),'err','Carga la configuración primero'); return; }
  const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='config.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#reset').addEventListener('click', ()=>{ localStorage.removeItem('fiestaConfig'); location.reload(); });

/* Verificación */
function buster(u){ return !u ? '' : u + (u.includes('?')?'&':'?') + '_=' + Date.now(); }
$('#vPing').addEventListener('click', async ()=>{
  $('#vMsg').style.display='none'; $('#vLog').textContent='';
  const url=$('#reservationScriptUrl').value.trim() || cfg?.reservationScriptUrl || '';
  if(!url){ show($('#vMsg'),'err','Completa la URL /exec'); return; }
  try{ const r=await fetch(buster(url)+'&ping=1',{mode:'cors'}); const t=await r.text(); show($('#vMsg'),'ok','Ping OK'); $('#vLog').textContent=t; }
  catch{ show($('#vMsg'),'err','No se pudo hacer ping'); }
});
$('#vDebug').addEventListener('click', async ()=>{
  $('#vMsg').style.display='none'; $('#vLog').textContent='';
  const url=$('#reservationScriptUrl').value.trim() || cfg?.reservationScriptUrl || '';
  if(!url){ show($('#vMsg'),'err','Completa la URL /exec'); return; }
  try{ const r=await fetch(buster(url)+'&debug=1',{mode:'cors'}); const t=await r.text(); show($('#vMsg'),'ok','Debug OK'); $('#vLog').textContent=t; }
  catch{ show($('#vMsg'),'err','No se pudo leer debug'); }
});
$('#vCSV').addEventListener('click', async ()=>{
  $('#vMsg').style.display='none'; $('#vLog').textContent='';
  const url=$('#guestsSheetCsvUrl').value.trim() || cfg?.guestsSheetCsvUrl || '';
  if(!url){ show($('#vMsg'),'err','Completa la URL del CSV'); return; }
  try{ const r=await fetch(buster(url),{mode:'cors'}); const t=await r.text(); const lines=t.trim().split(/\r?\n/);
    show($('#vMsg'),'ok',`CSV accesible (${lines.length} filas)`); $('#vLog').textContent=lines.slice(0,5).join('\n'); }
  catch{ show($('#vMsg'),'err','No se pudo leer el CSV'); }
});
/* NUEVO: prueba de POST con text/plain (igual que hace el index) */
$('#vPost').addEventListener('click', async ()=>{
  $('#vMsg').style.display='none'; $('#vLog').textContent='';
  const url=$('#reservationScriptUrl').value.trim() || cfg?.reservationScriptUrl || '';
  if(!url){ show($('#vMsg'),'err','Completa la URL /exec'); return; }
  try{
    const mesa=(cfg?.mesas?.[0]?.label)||'Mesa 1';
    const payload={
      submittedAt:new Date().toISOString(),
      mesa, grado:'TEST', escalafon:'TEST',
      nombre:'Prueba', apellido:'POST',
      cedula:'0.000.000-0', correo:'admin@test.com',
      menu:'normal', acompanante:'No', cantidadAcompanantes:0, acompanantes:[]
    };
    const r=await fetch(buster(url),{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload)
    });
    const t=await r.text();
    if(r.ok){ show($('#vMsg'),'ok','POST OK'); } else { show($('#vMsg'),'err','POST no OK'); }
    $('#vLog').textContent=t;
  }catch{ show($('#vMsg'),'err','No se pudo enviar POST'); }
});
/* Escritura de prueba con GET (legacy) */
$('#vWrite').addEventListener('click', async ()=>{
  $('#vMsg').style.display='none'; $('#vLog').textContent='';
  const url=$('#reservationScriptUrl').value.trim() || cfg?.reservationScriptUrl || '';
  if(!url){ show($('#vMsg'),'err','Completa la URL /exec'); return; }
  try{
    const mesa=(cfg?.mesas?.[0]?.label)||'Mesa 1';
    const r=await fetch(buster(url)+`&write=1&mesa=${encodeURIComponent(mesa)}&nombre=Prueba&apellido=Admin&cedula=0.000.000-0&correo=admin@test.com`,{mode:'cors'});
    const t=await r.text(); show($('#vMsg'),'ok','Escritura de prueba enviada'); $('#vLog').textContent=t;
  }catch{ show($('#vMsg'),'err','No se pudo escribir'); }
});

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{ try{ cfg=await loadConfig(); }catch{} });
</script>
</body>
</html>
