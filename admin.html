<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Administración · Fiesta Social</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--c1:#0b66ff;--c1d:#084dcc;--ok:#059669;--err:#ef4444;--bg:#fff;--mut:#475569;--b:#e2e8f0;--sh:0 24px 60px rgba(15,23,42,.18);--r:22px;font-family:Poppins,Segoe UI,sans-serif}
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:linear-gradient(135deg,#0f172a,#1e293b 60%,#0f172a);color:#0f172a;padding:32px;display:flex;justify-content:center}
  main{width:100%;max-width:1100px;display:grid;gap:24px}
  .card{background:var(--bg);border-radius:var(--r);padding:28px;box-shadow:var(--sh)}
  h1,h2{margin:0 0 12px} p{margin:0 0 12px;color:var(--mut)}
  label{font-weight:600;display:block;margin:8px 0 6px}
  input,textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:10px;background:#f8fafc}
  .btn{border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
  .p{background:var(--c1);color:#fff}.p:hover{background:var(--c1d)}
  .g{background:#eef2ff;color:var(--c1)} .d{background:#fee2e2;color:#b91c1c}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px}
  .status{display:none;margin-top:10px;padding:10px 12px;border-radius:10px;font-weight:600}
  .ok{display:block;background:rgba(5,150,105,.12);color:var(--ok)}
  .err{display:block;background:rgba(239,68,68,.12);color:var(--err)}
  @media (max-width: 720px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<main>
  <!-- Login -->
  <section class="card" id="loginCard">
    <h1>Panel de administración</h1>
    <p>Ingresa la contraseña para editar la configuración.</p>
    <label>Contraseña</label><input type="password" id="adminPass">
    <div style="margin-top:12px"><button class="btn p" id="loginBtn">Ingresar</button></div>
    <div id="loginStatus" class="status"></div>
  </section>

  <!-- Editor -->
  <section class="card" id="editorCard" hidden>
    <h2>Configuración general</h2>
    <div class="row">
      <div>
        <label>Título</label><input id="siteTitle">
        <label>Subtítulo</label><input id="siteSubtitle">
        <label>Descripción</label><textarea id="siteDescription"></textarea>
        <label>Imagen héroe (ruta/URL)</label><input id="heroImage">
      </div>
      <div>
        <label>URL Apps Script (/exec)</label><input id="reservationScriptUrl">
        <label>CSV publicado (opcional)</label><input id="guestsSheetCsvUrl">
        <label>Capacidad por defecto</label><input id="defaultCapacity" type="number" min="1" step="1">
      </div>
    </div>

    <h3 style="margin-top:16px">Tamaños de la representación (UI)</h3>
    <div class="row">
      <div>
        <label>Tamaño de botón de mesa (px)</label><input id="uiMesaSize" type="number" min="24" step="1">
        <label>Tamaño de asiento (px)</label><input id="uiSeatSize" type="number" min="20" step="1">
      </div>
      <div>
        <label>Diámetro de mesa circular (px)</label><input id="uiTableSize" type="number" min="80" step="1">
        <label>Escala de zonas (chips/etiquetas)</label><input id="uiZoneScale" type="number" min="0.6" step="0.1">
      </div>
    </div>

    <h3 style="margin-top:16px">Mesas</h3>
    <table id="mesasTable">
      <thead><tr><th>#</th><th>Etiqueta</th><th>Cap.</th><th>X%</th><th>Y%</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px"><button class="btn p" id="addMesa">Agregar mesa</button></div>

    <h3 style="margin-top:24px">Zonas del salón</h3>
    <table id="zonesTable">
      <thead><tr><th>ID</th><th>Etiqueta</th><th>Clases CSS</th><th>X%</th><th>Y%</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:10px"><button class="btn g" id="addZone">Agregar zona</button></div>

    <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn p" id="saveLocal">Guardar (navegador)</button>
      <button class="btn g" id="download">Descargar config.json</button>
      <button class="btn d" id="reset">Resetear</button>
      <a class="btn g" href="index.html">Volver al sitio</a>
    </div>
    <div id="saveStatus" class="status"></div>
  </section>
</main>

<script>
let cfg=null;

function $(id){return document.getElementById(id)}
function show(el,cls,msg){el.className='status '+cls;el.textContent=msg;el.style.display='block'}
function hide(el){el.style.display='none'}

async function sha256(text){
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadConfig(){
  try{const local=localStorage.getItem('fiestaConfig'); if(local) return JSON.parse(local);}catch{}
  const r=await fetch('config.json?_='+Date.now()); return await r.json();
}

function fillGeneral(){
  $('siteTitle').value=cfg.siteTitle||''; $('siteSubtitle').value=cfg.siteSubtitle||'';
  $('siteDescription').value=cfg.siteDescription||''; $('heroImage').value=cfg.heroImage||'';
  $('reservationScriptUrl').value=cfg.reservationScriptUrl||''; $('guestsSheetCsvUrl').value=cfg.guestsSheetCsvUrl||'';
  $('defaultCapacity').value=cfg.defaultCapacity||10;

  const ui = cfg.ui || {};
  $('uiMesaSize').value  = ui.mesaSize  ?? 52;
  $('uiSeatSize').value  = ui.seatSize  ?? 42;
  $('uiTableSize').value = ui.tableSize ?? 120;
  $('uiZoneScale').value = ui.zoneScale ?? 1;
}

function renderMesas(){
  const tb=$('mesasTable').querySelector('tbody'); tb.innerHTML='';
  if(!Array.isArray(cfg.mesas)) cfg.mesas=[];
  cfg.mesas.forEach((m,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="number" value="${m.number||i+1}" data-f="number"></td>
      <td><input value="${m.label||`Mesa ${i+1}`}" data-f="label"></td>
      <td><input type="number" min="1" step="1" value="${m.capacity||cfg.defaultCapacity||10}" data-f="capacity"></td>
      <td><input type="number" step="0.1" min="0" max="100" value="${m.position?.x??0}" data-f="x"></td>
      <td><input type="number" step="0.1" min="0" max="100" value="${m.position?.y??0}" data-f="y"></td>
      <td><button class="btn d" data-del>Eliminar</button></td>`;
    tr.querySelector('[data-del]').onclick=()=>{ cfg.mesas.splice(i,1); renderMesas(); };
    tb.appendChild(tr);
  });
}
function renderZones(){
  const tb=$('zonesTable').querySelector('tbody'); tb.innerHTML='';
  if(!Array.isArray(cfg.zones)) cfg.zones=[];
  cfg.zones.forEach((z,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input value="${z.id||''}" data-f="id"></td>
      <td><input value="${z.label||''}" data-f="label"></td>
      <td><input value="${z.className||''}" data-f="class"></td>
      <td><input type="number" step="0.1" min="0" max="100" value="${z.position?.x??0}" data-f="x"></td>
      <td><input type="number" step="0.1" min="0" max="100" value="${z.position?.y??0}" data-f="y"></td>
      <td><button class="btn d" data-del>Eliminar</button></td>`;
    tr.querySelector('[data-del]').onclick=()=>{ cfg.zones.splice(i,1); renderZones(); };
    tb.appendChild(tr);
  });
}

function getMesasFromTable(){
  const rows=[...$('mesasTable').querySelectorAll('tbody tr')];
  return rows.map(r=>{
    const get=f=>r.querySelector(`[data-f="${f}"]`).value;
    return {
      number: parseInt(get('number'),10)||0,
      label: get('label')||'',
      capacity: parseInt(get('capacity'),10)||parseInt($('defaultCapacity').value,10)||10,
      position:{ x: parseFloat(get('x'))||0, y: parseFloat(get('y'))||0 }
    };
  }).sort((a,b)=>(a.number||0)-(b.number||0));
}
function getZonesFromTable(){
  const rows=[...$('zonesTable').querySelectorAll('tbody tr')];
  return rows.map(r=>{
    const get=f=>r.querySelector(`[data-f="${f}"]`).value;
    return {
      id:(get('id')||'').trim(),
      label:(get('label')||'').trim(),
      className:(get('class')||'').trim(),
      position:{ x: parseFloat(get('x'))||0, y: parseFloat(get('y'))||0 }
    };
  }).filter(z=>z.id && z.label);
}

$('addMesa').onclick=()=>{ const ms=getMesasFromTable(); ms.push({number:(ms[ms.length-1]?.number||0)+1,label:'',capacity:parseInt($('defaultCapacity').value,10)||10,position:{x:50,y:50}}); cfg.mesas=ms; renderMesas(); };
$('addZone').onclick=()=>{ (cfg.zones||(cfg.zones=[])).push({id:`zona-${Math.random().toString(36).slice(2,7)}`,label:'Nueva zona',className:'',position:{x:50,y:50}}); renderZones(); };

$('saveLocal').onclick=()=>{
  cfg.siteTitle=$('siteTitle').value.trim();
  cfg.siteSubtitle=$('siteSubtitle').value.trim();
  cfg.siteDescription=$('siteDescription').value.trim();
  cfg.heroImage=$('heroImage').value.trim();
  cfg.reservationScriptUrl=$('reservationScriptUrl').value.trim();
  cfg.guestsSheetCsvUrl=$('guestsSheetCsvUrl').value.trim();
  cfg.defaultCapacity=parseInt($('defaultCapacity').value,10)||10;

  // guardar UI
  cfg.ui = {
    mesaSize:  parseFloat($('uiMesaSize').value)||52,
    seatSize:  parseFloat($('uiSeatSize').value)||42,
    tableSize: parseFloat($('uiTableSize').value)||120,
    zoneScale: parseFloat($('uiZoneScale').value)||1
  };

  cfg.mesas=getMesasFromTable();
  cfg.zones=getZonesFromTable();

  localStorage.setItem('fiestaConfig', JSON.stringify(cfg));
  show($('saveStatus'),'ok','Guardado en este navegador.');
};
$('download').onclick=()=>{
  const blob=new Blob([JSON.stringify(cfg,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='config.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('reset').onclick=()=>{ localStorage.removeItem('fiestaConfig'); location.reload(); };

$('loginBtn').onclick=async()=>{
  hide($('loginStatus'));
  try{
    cfg = await loadConfig();
    const hash = cfg?.admin?.passwordHash || '';
    if(!hash){ show($('loginStatus'),'err','No hay contraseña definida en config.json'); return; }
    const typed = await sha256($('adminPass').value);
    if(typed !== hash){ show($('loginStatus'),'err','Contraseña incorrecta'); return; }
    $('loginCard').hidden=true; $('editorCard').hidden=false;
    fillGeneral(); renderMesas(); renderZones();
  }catch(e){ show($('loginStatus'),'err','No se pudo cargar config.json'); }
};

document.addEventListener('DOMContentLoaded', async ()=>{ try{ cfg=await loadConfig(); }catch{} });
</script>
</body>
</html>
