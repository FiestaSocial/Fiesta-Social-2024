<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiesta Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{ --c1:#0b67ff;--c1d:#0b4fb6;--c2:#f59e0b;--mut:#6b7280;--b:#e5e7eb;
  --ok:#22c55e;--err:#ef4444;--bg:#fff;--sh:0 24px 60px rgba(15,23,42,.2);
  --r:28px;--r2:18px;--r3:12px; --mesa-size:52px;--seat-size:42px;--table-size:120px;--zone-scale:1; }
*{box-sizing:border-box}
body{ margin:0;min-height:100vh;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:radial-gradient(circle at 15% 10%,rgba(59,130,246,.35),transparent 50%),
             radial-gradient(circle at 85% 90%,rgba(234,179,8,.25),transparent 50%),#0f172a;
  color:#0f172a;padding:40px 16px 60px;display:flex;justify-content:center }
main{width:100%;max-width:1100px}
.container{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:28px;margin-bottom:28px}
.container:not(.active){display:none}
h1,h2,h3{margin:0 0 12px} p{margin:0 0 12px;color:#6b7280}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
.btn--pri{background:var(--c1);color:#fff}.btn--pri:hover{background:var(--c1d)} .btn--ghost{background:rgba(15,23,42,.06);color:#0b67ff}
.actions{display:flex;justify-content:flex-end;gap:12px;margin-top:16px}
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:28px;align-items:center}
.hero img{width:100%;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.15)}
.eyebrow{display:inline-block;background:rgba(11,103,255,.12);color:#0b67ff;padding:6px 12px;border-radius:999px;font-weight:600}
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
.field{display:flex;flex-direction:column;gap:6px}
.field>label{font-weight:600}
.field>input,.field>select,.field>textarea{width:100%;padding:10px 12px;border:1px solid var(--b);border-radius:var(--r3);background:#f8fafc;font-size:15px}
textarea{min-height:84px;resize:vertical}
.salon-wrapper{display:grid;grid-template-columns:260px 1fr;gap:28px;margin-bottom:32px}
.panel{background:#f8fafc;border:1px solid var(--b);border-radius:12px;padding:16px}
.legend{display:grid;gap:8px;margin-top:12px}
.dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;vertical-align:middle}
.dot.blue{background:var(--c1)}.dot.orange{background:var(--c2)}.dot.red{background:var(--err)}
.map-viewport{position:relative}
.map{position:relative;border-radius:16px;background:linear-gradient(135deg,rgba(226,232,240,.85),rgba(203,213,225,.6));box-shadow:0 12px 30px rgba(0,0,0,.15);aspect-ratio:16/9;overflow:hidden}
.zone{position:absolute;left:calc(var(--x,50)*1%);top:calc(var(--y,50)*1%);transform:translate(-50%,-50%);
  padding:calc(6px*var(--zone-scale)) calc(16px*var(--zone-scale)); border-radius:999px;background:rgba(15,23,42,.8);color:#fff;font-size:calc(12px*var(--zone-scale));font-weight:600; pointer-events:none; z-index:1 }
.zone.stage,.zone.entrance,.zone.dj,.zone.dessert{background:#3b82f6}.zone.dance{background:#22c55e}
.chair{position:absolute;width:var(--mesa-size);height:var(--mesa-size);border-radius:calc(var(--mesa-size)/3); background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700; transform:translate(-50%,-50%); z-index:2; cursor:pointer }
.chair.full{background:var(--err)}.chair.sel{background:var(--c2)}
.table-wrap{position:relative;width:100%;padding-top:100%;border-radius:16px;background:#f8fafc;border:1px solid var(--b)}
.table{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:var(--table-size);height:var(--table-size); border-radius:999px;background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:calc(var(--seat-size)/3);background:var(--ok);transform:translate(-50%,-50%)}
.seat.full{background:var(--err)}
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;padding:24px;z-index:100}
.modal-overlay.active{display:flex}
.modal-content{background:#fff;border-radius:24px;padding:28px;max-width:520px;box-shadow:var(--sh)}
.modal-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:16px}
@media (max-width: 640px) {
  body { padding: 20px 10px 32px; }
  .hero { grid-template-columns: 1fr; gap: 16px; }
  .grid { grid-template-columns: 1fr; }
  .salon-wrapper { grid-template-columns: 1fr; gap: 16px; }
  .map-viewport:not(.rotate) .map { aspect-ratio: auto; height: 56vh; min-height: 320px; }
  :root { --mesa-size: 40px; --seat-size: 30px; --table-size: 100px; }
  .table-wrap { min-height: 260px; }
  #guestList { min-height: 180px; max-height: 35vh; overflow: auto; }
}
@media (max-width: 640px) and (orientation: portrait) {
  .map-viewport.rotate { width: 100%; height: 72vh; min-height: 340px; position:relative; overflow:hidden; }
  .map-viewport.rotate .map {
    position: absolute; left: 50%; top: 50%;
    transform-origin: center center;
    transform: translate(-50%, -50%) rotate(90deg) scale(var(--map-scale, 1));
    width: 100%; height: auto;
  }
}
@media (max-width: 380px) { :root { --mesa-size: 36px; --seat-size: 28px; --table-size: 92px; } .btn { padding: 10px 14px; } }
</style>
</head>
<body>
<main>
  <section id="scr1" class="container active">
    <div class="hero" id="heroBox"></div>
  </section>

  <section id="scr2" class="container">
    <h2>Datos personales</h2>
    <form id="formMain" class="grid">
      <div class="field"><label for="email">Correo</label><input id="email" type="email" required autocomplete="email"></div>
      <div class="field"><label for="grado">Grado</label><select id="grado" required>
        <option value="">Seleccionar</option><option>Cnel.</option><option>Tte. Cnel.</option><option>May.</option><option>Cap.</option><option>Tte. 1¬∞</option><option>Tte. 2¬∞</option><option>Alf.</option>
      </select></div>
      <div class="field"><label for="escalafon">Escalaf√≥n</label><select id="escalafon" required>
        <option value="">Seleccionar</option><option>(Av.)</option><option>(Nav.)</option><option>(Esp.)</option><option>(T.P.)</option>
      </select></div>
      <div class="field"><label for="nombre">Nombre</label><input id="nombre" required autocomplete="given-name"></div>
      <div class="field"><label for="apellido">Apellido</label><input id="apellido" required autocomplete="family-name"></div>
      <div class="field"><label for="ci">C√©dula (0.000.000-0)</label><input id="ci" required inputmode="numeric" autocomplete="off"></div>
      <div class="field"><label for="menu">Men√∫</label><select id="menu" required>
        <option value="">Seleccionar</option><option>Normal</option><option>Vegetariano</option><option>Vegano</option><option>Cel√≠aco</option>
      </select></div>
      <div class="field" style="grid-column:1/-1"><label for="obs">Observaciones</label><textarea id="obs"></textarea></div>

      <div class="field"><label for="acomp">¬øAsiste con acompa√±ante?</label>
        <select id="acomp" required>
          <option value="">Seleccionar</option><option value="no" selected>No</option><option value="si">S√≠</option>
        </select>
      </div>

      <div class="field" id="boxCount" style="display:none"><label for="acompCount">¬øCu√°ntos acompa√±antes? (m√°x. 4)</label>
        <select id="acompCount" disabled>
          <option value="" selected>Seleccionar</option><option>1</option><option>2</option><option>3</option><option>4</option>
        </select>
      </div>

      <input type="hidden" id="selTable">
    </form>
    <div class="actions"><button class="btn btn--ghost" data-prev="1">Anterior</button><button class="btn btn--pri" data-next="3">Continuar</button></div>
  </section>

  <section id="scr3" class="container">
    <h2>Informaci√≥n de acompa√±antes</h2>
    <form id="formAcomp" class="grid"></form>
    <div class="actions"><button class="btn btn--ghost" data-prev="2">Anterior</button><button class="btn btn--pri" data-next="4">Continuar</button></div>
  </section>

  <section id="scr4" class="container">
    <h2>Selecciona tu mesa</h2>
    <div class="salon-wrapper">
      <aside class="panel">
        <h3>Resumen del sal√≥n</h3>
        <p><strong>Mesas:</strong> <span id="totMesas">‚Äî</span></p>
        <p><strong>Capacidad total:</strong> <span id="totCap">‚Äî</span></p>
        <p><strong>Mesa seleccionada:</strong> <span id="tagMesa">Sin seleccionar</span></p>
        <button class="btn btn--ghost" id="btnRefresh">üîÑ Refrescar ahora</button>
        <div class="legend"><div><span class="dot blue"></span>Disponible</div><div><span class="dot red"></span>Completa</div><div><span class="dot orange"></span>Seleccionada</div></div>
      </aside>
      <div class="map-viewport"><div id="map" class="map"></div></div>
    </div>

    <div class="grid">
      <div class="table-wrap">
        <div id="tableCanvas" class="table"></div>
        <div id="seating"></div>
      </div>
      <div class="panel">
        <h3>Invitados registrados en esta mesa</h3>
        <div id="guestList" style="min-height:160px">Selecciona una mesa para ver los invitados.</div>
      </div>
    </div>

    <div class="actions"><button class="btn btn--ghost" data-prev="3">Anterior</button><button id="btnSend" class="btn btn--pri">Enviar</button></div>
  </section>

  <div id="okModal" class="modal-overlay" style="display:none">
    <div class="modal-content"><h3>Registro completo</h3><p>Tu reserva se guard√≥ en <strong id="okMesa"></strong>.</p>
      <div class="modal-actions"><button id="btnOkClose" class="btn btn--pri">Cerrar</button></div></div></div>
  <div id="dupModal" class="modal-overlay" style="display:none">
    <div class="modal-content"><h3>Ya est√°s registrado</h3><pre id="dupInfo" style="white-space:pre-wrap"></pre>
      <div class="modal-actions"><button id="btnDupClose" class="btn btn--pri">Entendido</button></div></div></div>
</main>

<script>
const DEFAULT_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9-0xkSXU1-JKCslP7CA1X42fQ6CxO_ysq4ogVGk_s0UExBHBxFH48_0T9poJu-ZMC1w/exec"; // tu Apps Script

const state={cfg:null,guests:new Map(),poll:null};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const norm=s=>(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const bust=u=>!u?'':u+(u.includes('?')?'&':'?')+'_='+Date.now();

/* HERO */
function paintHero(){ $('#heroBox').innerHTML=`
  <div>
    <span class="eyebrow">${state.cfg?.siteSubtitle||'Registro oficial de invitados'}</span>
    <h1>${state.cfg?.siteTitle||'Fiesta Social'}</h1>
    <p>${state.cfg?.siteDescription||'Confirma tu asistencia, elige tu men√∫ y selecciona tu mesa.'}</p>
    <div class="actions" style="justify-content:flex-start;gap:12px">
      <button class="btn btn--pri" data-next="2">Comenzar registro</button>
      <a class="btn btn--ghost" href="admin.html">Administraci√≥n</a>
    </div>
  </div>
  <img src="${state.cfg?.heroImage||'Imagen de bienvenida.png'}" alt="Imagen de portada">`; }

/* ===== CI: validaci√≥n tolerante + autoformato ===== */
function ciDigits(v){ return String(v||'').replace(/\D/g,''); }
function ciSeemsFilled(v){ return ciDigits(v).length >= 7; }       // m√≠nimo 7 d√≠gitos
function ciFormatSmart(v){
  const d=ciDigits(v);
  if(d.length>=8){
    const body=d.slice(0,-1).padStart(7,'0').slice(-7), dv=d.slice(-1);
    return `${body[0]}.${body.slice(1,4)}.${body.slice(4)}-${dv}`;
  }
  return (v||'').trim();
}
document.getElementById('ci')?.addEventListener('blur',e=>{ e.target.value = ciFormatSmart(e.target.value); });

/* ===== Navegaci√≥n / validaci√≥n ===== */
function show(n){ $$('.container').forEach(el=>el.classList.toggle('active', el.id===`scr${n}`)); }
document.body.addEventListener('click',e=>{ const nx=e.target.closest('[data-next]'), pv=e.target.closest('[data-prev]'); if(nx){e.preventDefault(); nextFrom(+nx.dataset.next);} if(pv){e.preventDefault(); show(+pv.dataset.prev); stopPoll();} });
function validateScope(rootSel,onlyRequired=false){ const sc=$(rootSel), bad=[];
  sc.querySelectorAll('input,select,textarea').forEach(el=>{ if(el.offsetParent===null) return; if(onlyRequired && !el.required) return;
    if(el.id==='ci'){ if(!ciSeemsFilled(el.value)){ bad.push('C√©dula (m√≠nimo 7 d√≠gitos)'); } else el.value = ciFormatSmart(el.value); return; }
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA'){ el.value=(el.value||'').trim(); }
    if(!el.checkValidity()){ const lab=sc.querySelector(`label[for="\${el.id}"]`); bad.push((lab?lab.textContent:el.id).replace(':','')); }
  }); return bad;
}

/* ===== Acompa√±antes: UI robusta ===== */
function updateAcompUI(){
  const sel = document.getElementById('acomp');
  const box = document.getElementById('boxCount');
  const cnt = document.getElementById('acompCount');
  const raw = (sel?.value || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const withComp = (raw === 'si' || raw === 's' || raw === 'yes' || raw === 'y' || raw === '1' || raw === 'true');
  if (box) box.style.display = withComp ? '' : 'none';
  if (cnt) { cnt.disabled = !withComp; if (!withComp) cnt.value = ''; }
  if (!withComp) { const fa=document.getElementById('formAcomp'); if (fa) fa.innerHTML=''; }
}
document.getElementById('acomp')?.addEventListener('change', updateAcompUI);

/* ===== Navegaci√≥n con chequeo de acompa√±antes ===== */
function nextFrom(n){
  const raw = (document.getElementById('acomp')?.value || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const withComp = (raw === 'si' || raw === 's' || raw === 'yes' || raw === 'y' || raw === '1' || raw === 'true');

  if(n===3){
    const bad=validateScope('#scr2'); if(bad.length){ alert('Completa:\n- '+bad.join('\n- ')); return; }
    if(withComp){
      const q=parseInt(document.getElementById('acompCount').value||'1',10)||1;
      renderAcompanantes(Math.min(4,Math.max(1,q))); show(3);
    }else{
      renderAcompanantes(0); show(4); paintHall(); refreshGuests(); startPoll(); applyHallMobileRotation();
    }
  }else if(n===4){
    if(withComp){ const bad=validateScope('#scr3',true); if(bad.length){ alert('Faltan datos:\n- '+bad.join('\n- ')); return; } }
    show(4); paintHall(); refreshGuests(); startPoll(); applyHallMobileRotation();
  }else show(n);
}

/* ===== Acompa√±antes ===== */
function renderAcompanantes(n){
  const box=document.getElementById('formAcomp'); box.innerHTML='';
  for(let i=1;i<=n;i++){
    box.insertAdjacentHTML('beforeend',`
      <div class="field"><label>Nombre (Acompa√±ante ${i})</label><input required></div>
      <div class="field"><label>Apellido</label><input></div>
      <div class="field"><label>C√©dula (0.000.000-0)</label><input required></div>
      <div class="field"><label>Men√∫</label>
        <select><option value="">Seleccionar</option><option>Normal</option><option>Vegetariano</option><option>Vegano</option><option>Cel√≠aco</option></select>
      </div>`);
  }
}

/* ===== Sal√≥n ===== */
function makeRemapFn(points, marginX=8, marginY=8){ const xs=points.map(p=>p.x), ys=points.map(p=>p.y);
  let minX=Math.min(...xs), maxX=Math.max(...xs); let minY=Math.min(...ys), maxY=Math.max(...ys);
  if(minX===maxX){minX=0;maxX=100} if(minY===maxY){minY=0;maxY=100}
  const rx=(maxX-minX)||1, ry=(maxY-minY)||1;
  return ({x,y})=>({ x: marginX + ((x-minX)/rx)*(100-2*marginX), y: marginY + ((y-minY)/ry)*(100-2*marginY) });
}
function paintHall(){ const map=document.getElementById('map'); map.innerHTML='';
  const zones=(state.cfg?.zones?.length?state.cfg.zones:[
    {id:'stage',label:'Estado Mayor',className:'zone stage',position:{x:20,y:90}},
    {id:'entrance',label:'Entrada / Lido',className:'zone entrance',position:{x:48,y:95}},
    {id:'dance',label:'Pista de baile',className:'zone dance',position:{x:48,y:45}},
    {id:'dj',label:'DJ',className:'zone dj',position:{x:53,y:5}},
    {id:'dessertLeft',label:'Barra',className:'zone dessert',position:{x:45,y:5}}
  ]);
  const mesas=(state.cfg?.mesas||[]).slice().sort((a,b)=>(a.number||0)-(b.number||0));

  const isPortraitMobile = window.matchMedia('(max-width: 640px) and (orientation: portrait)').matches;
  let remap = p=>p;
  if(isPortraitMobile){ const points=[...zones.map(z=>z.position), ...mesas.map(m=>m.position)]; remap = makeRemapFn(points, 6, 6); }

  zones.forEach(z=>{ const p = z.position ? remap(z.position) : {x:50,y:50};
    const el=document.createElement('div'); el.className = z.className?.includes('zone') ? z.className : `zone ${z.className||''}`;
    el.style.setProperty('--x', p.x); el.style.setProperty('--y', p.y);
    el.style.setProperty('--zone-scale', z?.scale!=null ? +z.scale : (state.cfg?.ui?.zoneScale ?? 1));
    el.textContent = z.label || z.id || ''; map.appendChild(el);
  });

  mesas.forEach(mm=>{ const p = mm.position ? remap(mm.position) : {x:50,y:50};
    const b=document.createElement('button'); b.type='button'; b.className='chair'; b.style.left=p.x+'%'; b.style.top=p.y+'%';
    b.textContent=mm.number||''; b.dataset.mesa=mm.label||`Mesa ${mm.number}`; b.dataset.capacity=mm.capacity||state.cfg?.defaultCapacity||10;
    b.addEventListener('click',()=>selectTable(b.dataset.mesa)); map.appendChild(b);
  });

  document.getElementById('totMesas').textContent=mesas.length;
  document.getElementById('totCap').textContent=mesas.reduce((s,x)=>s+(x.capacity||state.cfg?.defaultCapacity||10),0);
}
document.getElementById('map')?.addEventListener('click',(e)=>{ const btn=e.target.closest('.chair'); if(btn?.dataset?.mesa) selectTable(btn.dataset.mesa); });
function selectTable(lbl){ document.getElementById('selTable').value=lbl; document.getElementById('tagMesa').textContent=lbl;
  Array.from(document.querySelectorAll('#map .chair')).forEach(c=>c.classList.toggle('sel', c.dataset.mesa===lbl));
  updateTablePreview(); paintGuestList();
}
function getMesaCapacity(lbl){ const m=(state.cfg?.mesas||[]).find(x=>(x.label||`Mesa ${x.number}`)===lbl);
  return m?(m.capacity||state.cfg?.defaultCapacity||10):(state.cfg?.defaultCapacity||10);
}
function updateTablePreview(){ const lbl=document.getElementById('selTable')?.value; const wrap=document.querySelector('.table-wrap');
  if(!lbl){ if(wrap) wrap.style.display='none'; return; } if(wrap) wrap.style.display='block';
  document.getElementById('tableCanvas').textContent=lbl;
  const cap=getMesaCapacity(lbl), cont=document.getElementById('seating'); cont.innerHTML='';
  const tableSize=+getComputedStyle(document.documentElement).getPropertyValue('--table-size').replace('px','')||120;
  const seatSize =+getComputedStyle(document.documentElement).getPropertyValue('--seat-size').replace('px','')||42;
  const CX=50,CY=50,R=Math.max(28,tableSize*0.32)+seatSize*0.25;
  for(let i=1;i<=cap;i++){ const s=document.createElement('div'); s.className='seat'; s.dataset.pos=i;
    const a=(i/cap)*2*Math.PI; s.style.left=`${CX+R*Math.cos(a)}%`; s.style.top=`${CY+R*Math.sin(a)}%`; cont.appendChild(s); }
  let used=0; (state.guests.get(lbl)||[]).forEach(r=>{
    let n=1; try{const j=JSON.parse(r['JSON original']||'')||{}; n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{}
    for(let i=0;i<n;i++){ const s=cont.querySelector(`.seat[data-pos="${++used}"]`); if(s) s.classList.add('full');}
  });
}
function paintGuestList(){ const lbl=document.getElementById('selTable')?.value, box=document.getElementById('guestList'); if(!box) return; box.innerHTML='';
  if(!lbl){ box.textContent='Selecciona una mesa para ver los invitados.'; return; }
  const rows=state.guests.get(lbl)||[]; if(!rows.length){ box.textContent='No hay invitados registrados en esta mesa.'; return; }
  rows.forEach(r=>{ const tit=((r['Nombre']||'')+' '+(r['Apellido']||'')).trim()||'Invitado'; box.insertAdjacentHTML('beforeend',`<div>‚Ä¢ <strong>${tit}</strong></div>`);
    try{ const j=JSON.parse(r['JSON original']||'')||{}; const A=Array.isArray(j.acompanantes)?j.acompanantes:[];
      A.forEach(a=>{ const nm=[a?.nombre||'',a?.apellido||''].filter(Boolean).join(' ').trim(); box.insertAdjacentHTML('beforeend',`<div>‚Ä¢ ${nm||'Acompa√±ante'}</div>`);}); }catch{} });
}

/* Lectura ocupaci√≥n */
function snapFor(lbl,map){const rows=(map.get(lbl)||[]);try{return JSON.stringify(rows.map(r=>`${r['Nombre']||''}|${r['Apellido']||''}|${r['JSON original']||''}`))}catch{return''}}
async function refreshGuests(silent=false){
  const prev=new Map(state.guests); const sel=document.getElementById('selTable')?.value; const prevSig=snapFor(sel,prev);
  let next=null;
  const base=state.cfg?.reservationScriptUrl || DEFAULT_SCRIPT_URL;
  if(base){ try{ const u=base+(base.includes('?')?'&':'?')+'read=1&limit=2000&_='+Date.now(); const r=await fetch(u,{mode:'cors'}); if(r.ok){ const j=await r.json(); next=valuesToMap(Array.isArray(j?.values)?j.values:[]); } }catch{} }
  if(!next && state.cfg?.guestsSheetCsvUrl){ try{ const r=await fetch(bust(state.cfg.guestsSheetCsvUrl),{mode:'cors'}); if(r.ok){ next=csvToMap(await r.text()); } }catch{} }
  if(!next){ if(!silent) console.warn('No se pudo leer la hoja; mantengo estado.'); return; }
  state.guests=next; updateChairsFull();
  const nextSig=snapFor(sel,next); if(sel && prevSig!==nextSig){ paintGuestList(); updatePreviewSeatsOnly(); }
}
function updateChairsFull(){ Array.from(document.querySelectorAll('#map .chair')).forEach(ch=>{ const lbl=ch.dataset.mesa; const cap=+ch.dataset.capacity; const rows=state.guests.get(lbl)||[]; let used=0;
  rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} used+=n;});
  ch.classList.toggle('full', used>=cap); });
}
function updatePreviewSeatsOnly(){ const lbl=document.getElementById('selTable')?.value; if(!lbl) return; Array.from(document.querySelectorAll('#seating .seat')).forEach(s=>s.classList.remove('full')); const rows=state.guests.get(lbl)||[]; let used=0;
  rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} for(let i=0;i<n;i++){ const s=document.querySelector('#seating .seat[data-pos="'+(++used)+'"]'); if(s) s.classList.add('full'); }});
}

/* Parsers */
function parseCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}else if(ch===','&&!q){out.push(cur);cur='';}else{cur+=ch}}out.push(cur);return out;}
function csvToMap(csv){if(!csv)return new Map();const lines=csv.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(x=>x.trim()!=='');if(!lines.length)return new Map();const headers=parseCSVLine(lines[0]);const normH=headers.map(h=>h.trim());const lower=normH.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const jsonI=lower.findIndex(k=>k.includes('json'));const map=new Map();for(let i=1;i<lines.length;i++){const v=parseCSVLine(lines[i]);if(v.every(x=>!x||x.trim()===''))continue;const row={};normH.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m='';if(mesaI!==-1)m=row[normH[mesaI]]||'';if(!m&&jsonI!==-1&&row[normH[jsonI]]){try{const p=JSON.parse(row[normH[jsonI]]);if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}
function valuesToMap(vals){if(!Array.isArray(vals)||!vals.length)return new Map();const headers=vals[0].map(h=>String(h||'').trim());const lower=headers.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const map=new Map();for(let i=1;i<vals.length;i++){const v=vals[i]||[];const row={};headers.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m=mesaI!==-1?String(v[mesaI]||'').trim():'';if(!m&&row['JSON original']){try{const p=JSON.parse(String(row['JSON original']));if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}

/* UI desde config */
async function loadConfig(){ try{ const local=localStorage.getItem('fiestaConfig'); if(local){ state.cfg=JSON.parse(local); } else { const r=await fetch('config.json?_='+Date.now()); if(!r.ok) throw new Error('No se pudo cargar config.json'); state.cfg=await r.json(); } }catch{ state.cfg={}; } state.cfg.reservationScriptUrl = state.cfg.reservationScriptUrl || DEFAULT_SCRIPT_URL; }
function applyUiSizes(){ const ui=state.cfg?.ui||{}; const root=document.documentElement; if(ui.mesaSize) root.style.setProperty('--mesa-size', `${ui.mesaSize}px`); if(ui.seatSize) root.style.setProperty('--seat-size', `${ui.seatSize}px`); if(ui.tableSize) root.style.setProperty('--table-size', `${ui.tableSize}px`); if(ui.zoneScale!=null) root.style.setProperty('--zone-scale', ui.zoneScale); }

/* Rotaci√≥n centrada en m√≥vil */
function applyHallMobileRotation(){ const vp=document.querySelector('.map-viewport'); const map=document.getElementById('map'); if(!vp||!map) return;
  const isPortraitMobile = window.matchMedia('(max-width: 640px) and (orientation: portrait)').matches; vp.classList.toggle('rotate', isPortraitMobile);
  if(!isPortraitMobile){ map.style.removeProperty('--map-scale'); return; } const prev = map.style.transform; map.style.transform='none'; map.style.width='100%'; map.style.height='';
  const vw = vp.clientWidth, vh = vp.clientHeight; const mw = map.clientWidth, mh = map.clientHeight; const safe = 0.96; const k = safe*Math.min(vw/mh, vh/mw);
  map.style.setProperty('--map-scale', k.toFixed(5)); map.style.transform = prev || '';
}
window.addEventListener('resize', applyHallMobileRotation);

/* Env√≠o y confirmaci√≥n */
function get(id){ return document.getElementById(id)?.value?.trim() || ''; }
function collectPayload(){ const payload = {
  correo:get('email'), grado:get('grado'), escalafon:get('escalafon'), nombre:get('nombre'), apellido:get('apellido'), cedula:get('ci'),
  menu:get('menu'), observaciones:get('obs'), mesa:get('selTable'), acompanantes:[], submittedAt:new Date().toISOString(), source:'web'
}; const raw=(document.getElementById('acomp')?.value||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const withComp=(raw==='si'||raw==='s'||raw==='yes'||raw==='y'||raw==='1'||raw==='true'); if(withComp){ const n=parseInt(document.getElementById('acompCount').value||'1',10)||1; const fs=Array.from(document.querySelectorAll('#formAcomp .field input, #formAcomp .field select'));
  for(let i=1;i<=n;i++){ const b=(i-1)*4; payload.acompanantes.push({ nombre:fs[b]?.value?.trim()||'', apellido:fs[b+1]?.value?.trim()||'', cedula:fs[b+2]?.value?.trim()||'', menu:fs[b+3]?.value||'' }); } } return payload; }
function findDuplicate(email, ci){ const matches=[]; for(const [mesa, arr] of state.guests.entries()){ for(const r of arr){ const keys=Object.keys(r||{});
  const g=k=>(r[k]||'').toString().trim(); const ciClean=s=>(s||'').toString().replace(/\D/g,''); const mailKey=keys.find(k=>/correo|email/i.test(k)); const ciKey=keys.find(k=>/c[e√©]dula|cedula|ci/i.test(k)); let ok=false;
  if(email && mailKey && g(mailKey).toLowerCase()===email.toLowerCase()) ok=true; if(ci && ciKey && ciClean(g(ciKey))===ciClean(ci)) ok=true;
  try{ const j=JSON.parse(r['JSON original']||'{}'); if(j?.correo && email && j.correo.toLowerCase()===email.toLowerCase()) ok=true; if(j?.cedula && ci && ciClean(j.cedula)===ciClean(ci)) ok=true; }catch{} if(ok) matches.push({mesa, r}); } } return matches; }
function mesaOcupacion(lbl){ const rows=state.guests.get(lbl)||[]; let used=0; rows.forEach(r=>{ let n=1; try{const j=JSON.parse(r['JSON original']||'')||{}; n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} used+=n; }); return used; }
function looksLikeSuccess(text, contentType){ const t=(text||'').toLowerCase(); if(/application\/json/i.test(contentType||'')){ try{ const j=JSON.parse(text); if(j && (j.ok||j.success||j.status==='ok')) return true; }catch{} } return /(ok|success|escrito|guardado|done)/i.test(t); }
async function confirmWritten(email, ci, tries=4){ for(let i=0;i<tries;i++){ await refreshGuests(true); if(findDuplicate(email, ci).length) return true; await new Promise(r=>setTimeout(r, 500)); } return false; }
async function sendReservation(e){ if(e) e.preventDefault();
  const bad=validateScope('#scr2'); if(bad.length){ alert('Completa:\n- '+bad.join('\n- ')); return; }
  const raw=(document.getElementById('acomp')?.value||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); const withComp=(raw==='si'||raw==='s'||raw==='yes'||raw==='y'||raw==='1'||raw==='true');
  if(withComp){ const badA=validateScope('#scr3',true); if(badA.length){ alert('Faltan datos:\n- '+badA.join('\n- ')); return; } }
  const mesa=get('selTable'); if(!mesa){ alert('Selecciona tu mesa antes de enviar.'); return; }
  const cap=getMesaCapacity(mesa); const P=collectPayload(); const total = 1 + (Array.isArray(P.acompanantes)?P.acompanantes.length:0); const ocup = mesaOcupacion(mesa);
  if(ocup + total > cap){ alert(`La mesa "\${mesa}" no tiene suficientes lugares.\nDisponibles: \${Math.max(0, cap-ocup)}.`); return; }
  const base = state.cfg?.reservationScriptUrl || DEFAULT_SCRIPT_URL; if(!base){ alert('Falta la URL del Apps Script'); return; }
  let wrote=false, respText='', ctype='';
  try{ const r=await fetch(base, {method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(P)}); ctype=r.headers.get('content-type')||''; respText=await r.text(); wrote = r.ok && looksLikeSuccess(respText, ctype); }catch{}
  if(!wrote){ try{ const q=new URLSearchParams({write:'1', payload: JSON.stringify(P)}); const r=await fetch(base+(base.includes('?')?'&':'?')+q.toString(), {mode:'cors'}); ctype=r.headers.get('content-type')||''; respText=await r.text(); wrote = r.ok && looksLikeSuccess(respText, ctype);}catch{} }
  let confirmed=false; if(wrote){ try{ confirmed = await confirmWritten(P.correo, P.cedula, 4); }catch{} }
  if(wrote && confirmed){ document.getElementById('okMesa').textContent=P.mesa; const m=document.getElementById('okModal'); m.style.display='flex'; m.classList.add('active'); try{ await refreshGuests(true); updateTablePreview(); }catch{} }
  else{ alert('No se pudo confirmar la escritura en la hoja.\n\nRespuesta del servidor:\n'+(respText||'‚Äî')); }
}

/* Eventos */
document.getElementById('btnRefresh')?.addEventListener('click',()=>refreshGuests().then(()=>alert('Informaci√≥n actualizada')));
document.getElementById('btnSend')?.addEventListener('click', sendReservation);
document.getElementById('btnOkClose')?.addEventListener('click',()=>{const m=document.getElementById('okModal'); m.classList.remove('active'); m.style.display='none'; location.reload();});
document.getElementById('btnDupClose')?.addEventListener('click',()=>{const m=document.getElementById('dupModal'); m.classList.remove('active'); m.style.display='none';});

/* Poll */
function startPoll(){ stopPoll(); state.poll=setInterval(()=>refreshGuests(true),20000); }
function stopPoll(){ if(state.poll){ clearInterval(state.poll); state.poll=null; } }
window.addEventListener('visibilitychange', ()=>{ if(document.hidden){ stopPoll(); } else { startPoll(); } });
window.addEventListener('beforeunload', stopPoll);

/* Boot */
(async function init(){ try{ await loadConfig(); applyUiSizes(); document.title = state.cfg?.siteTitle || document.title; paintHero(); show(1); updateAcompUI(); }catch(e){ alert('No se pudo cargar config.json'); } })();
</script>
</body>
</html>
