<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fiesta Social 2024</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --c1:#0b67ff;--c1d:#0b4fb6;--c2:#f59e0b;--mut:#6b7280;--b:#e5e7eb;
  --ok:#22c55e;--err:#ef4444;--bg:#fff;--sh:0 24px 60px rgba(15,23,42,.2);
  --r:28px;--r2:18px;--r3:12px;
  /* UI (puede venir desde config.ui) */
  --mesa-size:52px;--seat-size:42px;--table-size:120px;--zone-scale:1;
}
*{box-sizing:border-box}
body{
  margin:0;min-height:100vh;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(circle at 15% 10%,rgba(59,130,246,.35),transparent 50%),
    radial-gradient(circle at 85% 90%,rgba(234,179,8,.25),transparent 50%),
    #0f172a;
  color:#0f172a;padding:40px 16px 60px;display:flex;justify-content:center
}
main{width:100%;max-width:1100px}
.container{background:var(--bg);border-radius:var(--r);box-shadow:var(--sh);padding:28px;margin-bottom:28px}
.container:not(.active){display:none}
h1,h2,h3{margin:0 0 12px}
p{margin:0 0 12px;color:var(--mut)}
/* botones */
.btn{display:inline-flex;align-items:center;gap:.5rem;border:none;border-radius:999px;padding:10px 18px;font-weight:600;cursor:pointer}
.btn--pri{background:var(--c1);color:#fff}.btn--pri:hover{background:var(--c1d)}
.btn--ghost{background:rgba(15,23,42,.06);color:#0b67ff}
.actions{display:flex;justify-content:flex-end;gap:12px;margin-top:16px}

/* hero */
.hero{display:grid;grid-template-columns:1.1fr .9fr;gap:28px;align-items:center}
.hero img{width:100%;border-radius:16px;box-shadow:0 12px 30px rgba(0,0,0,.15)}
.eyebrow{display:inline-block;background:rgba(11,103,255,.12);color:#0b67ff;padding:6px 12px;border-radius:999px;font-weight:600}

/* formularios */
.grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
.field{display:flex;flex-direction:column;gap:6px}
.field>label{font-weight:600}
.field>input,.field>select,.field>textarea{padding:10px 12px;border:1px solid var(--b);border-radius:var(--r3);background:#f8fafc;font-size:15px}
textarea{min-height:84px;resize:vertical}

/* sal√≥n */
.salon-wrapper{display:grid;grid-template-columns:260px 1fr;gap:28px;margin-bottom:32px}
.panel{background:#f8fafc;border:1px solid var(--b);border-radius:12px;padding:16px}
.legend{display:grid;gap:8px;margin-top:12px}
.dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px;vertical-align:middle}
.dot.blue{background:var(--c1)}.dot.orange{background:var(--c2)}.dot.red{background:var(--err)}

.map{position:relative;border-radius:16px;background:linear-gradient(135deg,rgba(226,232,240,.85),rgba(203,213,225,.6));box-shadow:0 12px 30px rgba(0,0,0,.15);aspect-ratio:16/9}
.zone{position:absolute;white-space:nowrap;transform:translate(-50%,-50%);
  padding:calc(6px*var(--zone-scale,1)) calc(16px*1.1*var(--zone-scale,1));
  border-radius:999px;background:rgba(15,23,42,.8);color:#fff;font-size:calc(12px*var(--zone-scale,1));font-weight:600}
.zone.stage,.zone.entrance,.zone.dj,.zone.dessert{background:#3b82f6}.zone.dance{background:#22c55e}
.chair{position:absolute;width:var(--mesa-size);height:var(--mesa-size);border-radius:calc(var(--mesa-size)/3);
  background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;transform:translate(-50%,-50%)}
.chair.full{background:var(--err)}.chair.sel{background:var(--c2)}

.table-wrap{position:relative;width:100%;padding-top:100%;border-radius:16px;background:#f8fafc;border:1px solid var(--b)}
.table{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:var(--table-size);height:var(--table-size);
  border-radius:999px;background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
.seat{position:absolute;width:var(--seat-size);height:var(--seat-size);border-radius:calc(var(--seat-size)/3);background:var(--ok);transform:translate(-50%,-50%)}
.seat.full{background:var(--err)}

/* modales */
.modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;padding:24px;z-index:100}
.modal-overlay.active{display:flex}
.modal-content{background:#fff;border-radius:24px;padding:28px;max-width:520px;box-shadow:var(--sh)}
.modal-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:16px}

/* m√≥vil */
@media(max-width:900px){
  .hero{grid-template-columns:1fr}
  .map{aspect-ratio:auto;height:56vw;min-height:280px}
  .salon-wrapper{grid-template-columns:1fr}
}
</style>
</head>
<body>
<main>
  <!-- HERO -->
  <section id="scr1" class="container active">
    <div class="hero" id="heroBox"></div>
  </section>

  <!-- DATOS -->
  <section id="scr2" class="container">
    <h2>Datos personales</h2>
    <form id="formMain" class="grid">
      <div class="field"><label>Correo</label><input id="email" type="email" required></div>
      <div class="field"><label>Grado</label><select id="grado" required>
        <option value="">Seleccionar</option><option>Cnel.</option><option>Tte. Cnel.</option><option>May.</option><option>Cap.</option><option>Tte. 1¬∞</option><option>Tte. 2¬∞</option><option>Alf.</option>
      </select></div>
      <div class="field"><label>Escalaf√≥n</label><select id="escalafon" required>
        <option value="">Seleccionar</option><option>(Av.)</option><option>(Nav.)</option><option>(Esp.)</option><option>(T.P.)</option>
      </select></div>
      <div class="field"><label>Nombre</label><input id="nombre" required></div>
      <div class="field"><label>Apellido</label><input id="apellido" required></div>
      <div class="field"><label>C√©dula (0.000.000-0)</label><input id="ci" required pattern="^\d(\.?\d{3}){2}-\d$"></div>
      <div class="field"><label>Men√∫</label><select id="menu" required>
        <option value="">Seleccionar</option><option>Normal</option><option>Vegetariano</option><option>Vegano</option><option>Cel√≠aco</option>
      </select></div>
      <div class="field" style="grid-column:1/-1"><label>Observaciones</label><textarea id="obs"></textarea></div>
      <div class="field"><label>¬øAsiste con acompa√±ante?</label><select id="acomp" required>
        <option value="">Seleccionar</option><option value="no">No</option><option value="si">S√≠</option>
      </select></div>
      <div class="field" id="boxCount" style="display:none"><label>¬øCu√°ntos acompa√±antes? (m√°x. 4)</label>
        <select id="acompCount"><option value="">Seleccionar</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
      </div>
    </form>
    <div class="actions">
      <button class="btn btn--ghost" data-prev="1">Anterior</button>
      <button class="btn btn--pri" data-next="3">Continuar</button>
    </div>
  </section>

  <!-- ACOMPA√ëANTES -->
  <section id="scr3" class="container">
    <h2>Informaci√≥n de acompa√±antes</h2>
    <form id="formAcomp" class="grid"></form>
    <div class="actions">
      <button class="btn btn--ghost" data-prev="2">Anterior</button>
      <button class="btn btn--pri" data-next="4">Continuar</button>
    </div>
  </section>

  <!-- MESAS -->
  <section id="scr4" class="container">
    <h2>Selecciona tu mesa</h2>
    <div class="salon-wrapper">
      <aside class="panel">
        <h3>Resumen del sal√≥n</h3>
        <p><strong>Mesas:</strong> <span id="totMesas">‚Äî</span></p>
        <p><strong>Capacidad total:</strong> <span id="totCap">‚Äî</span></p>
        <p><strong>Mesa seleccionada:</strong> <span id="tagMesa">Sin seleccionar</span></p>
        <button class="btn btn--ghost" id="btnRefresh">üîÑ Refrescar ahora</button>
        <div class="legend">
          <div><span class="dot blue"></span>Disponible</div>
          <div><span class="dot red"></span>Completa</div>
          <div><span class="dot orange"></span>Seleccionada</div>
        </div>
      </aside>
      <div id="map" class="map"></div>
    </div>

    <div class="grid">
      <div class="table-wrap">
        <div id="tableCanvas" class="table"></div>
        <div id="seating"></div>
      </div>
      <div class="panel">
        <h3>Invitados registrados en esta mesa</h3>
        <div id="guestList" style="min-height:160px">Selecciona una mesa para ver los invitados.</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn--ghost" data-prev="3">Anterior</button>
      <button id="btnSend" class="btn btn--pri">Enviar</button>
    </div>
  </section>

  <!-- MODALES (arrancan ocultos) -->
  <div id="okModal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <h3>Registro completo</h3>
      <p>Tu reserva se guard√≥ en <strong id="okMesa"></strong>. Si deseas realizar un cambio, comun√≠cate con la Sec. Contable de la B.A. III.</p>
      <div class="modal-actions"><button id="btnOkClose" class="btn btn--pri">Cerrar</button></div>
    </div>
  </div>

  <div id="dupModal" class="modal-overlay" style="display:none">
    <div class="modal-content">
      <h3>Ya est√°s registrado</h3>
      <pre id="dupInfo" style="white-space:pre-wrap"></pre>
      <div class="modal-actions"><button id="btnDupClose" class="btn btn--pri">Entendido</button></div>
    </div>
  </div>
</main>

<script>
/* ===== Estado / utils ===== */
const state={cfg:null,guests:new Map(),poll:null};
const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
const norm=s=>(s??'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
const bust=u=>!u?'':u+(u.includes('?')?'&':'?')+'_='+Date.now();

/* ===== Hero ===== */
function paintHero(){
  $('#heroBox').innerHTML=`
    <div>
      <span class="eyebrow">${state.cfg?.siteSubtitle||'Registro oficial de invitados'}</span>
      <h1>${state.cfg?.siteTitle||'Fiesta Social 2024'}</h1>
      <p>${state.cfg?.siteDescription||'Confirma tu asistencia, elige tu men√∫ y selecciona tu mesa.'}</p>
      <div class="actions" style="justify-content:flex-start;gap:12px">
        <button class="btn btn--pri" data-next="2">Comenzar registro</button>
        <a class="btn btn--ghost" href="admin.html">Administraci√≥n</a>
      </div>
    </div>
    <img src="${state.cfg?.heroImage||'Imagen de bienvenida.png'}" alt="Imagen de portada">
  `;
}

/* ===== Navegaci√≥n ===== */
function show(n){ $$('.container').forEach(el=>el.classList.toggle('active', el.id===`scr${n}`)); }
document.body.addEventListener('click',e=>{
  const nx=e.target.closest('[data-next]'), pv=e.target.closest('[data-prev]');
  if(nx){ e.preventDefault(); nextFrom(+nx.dataset.next); }
  if(pv){ e.preventDefault(); show(+pv.dataset.prev); }
});

/* ===== Validaciones / pasos ===== */
function validateScope(rootSel, skipOptional=false){
  const sc=$(rootSel), bad=[];
  sc.querySelectorAll('input,select,textarea').forEach(el=>{
    if(el.offsetParent===null) return;                 // ignora ocultos
    if(skipOptional && !el.required) return;
    if(!el.checkValidity()){
      const lab=sc.querySelector(`label[for="${el.id}"]`);
      bad.push((lab?lab.textContent:el.id).replace(':',''));
    }
  }); return bad;
}
function nextFrom(n){
  const acompVal = ($('#acomp')?.value||'').toLowerCase();
  if(n===3){
    const bad=validateScope('#scr2'); if(bad.length){ alert('Completa:\n- '+bad.join('\n- ')); return; }
    if(acompVal==='si'){
      const qty = +($('#acompCount').value||0); renderAcompanantes(Math.min(4, Math.max(1, qty))); show(3);
    }else{
      renderAcompanantes(0); show(4); paintHall(); refreshGuests(); startPoll();
    }
  }else if(n===4){
    if(acompVal==='si'){ const bad=validateScope('#scr3',true); if(bad.length){ alert('Faltan datos:\n- '+bad.join('\n- ')); return; } }
    show(4); paintHall(); refreshGuests(); startPoll();
  }else show(n);
}

/* ===== Acompa√±antes ===== */
function renderAcompanantes(n){
  const box=$('#formAcomp'); box.innerHTML='';
  for(let i=1;i<=n;i++){
    box.insertAdjacentHTML('beforeend',`
      <div class="field"><label>Nombre (Acompa√±ante ${i})</label><input required></div>
      <div class="field"><label>Apellido</label><input></div>
      <div class="field"><label>C√©dula (0.000.000-0)</label><input required pattern="^\\d(\\.?\\d{3}){2}-\\d$"></div>
      <div class="field"><label>Men√∫</label>
        <select><option value="">Seleccionar</option><option>Normal</option><option>Vegetariano</option><option>Vegano</option><option>Cel√≠aco</option></select>
      </div>
      <div class="field" style="grid-column:1/-1"><label>Observaciones</label><textarea placeholder="Alergias, preferencias, etc."></textarea></div>
    `);
  }
}
$('#acomp').addEventListener('change',e=>$('#boxCount').style.display = e.target.value==='si'?'block':'none');

/* ===== Sal√≥n ===== */
function paintHall(){
  const map=$('#map'); map.innerHTML='';
  const zones=(state.cfg?.zones?.length?state.cfg.zones:[
    {id:'stage',label:'Estado Mayor',className:'zone stage',position:{x:20,y:55}},
    {id:'entrance',label:'Entrada / Piscina',className:'zone entrance',position:{x:55,y:12}},
    {id:'dance',label:'Pista de baile',className:'zone dance',position:{x:50,y:45}},
    {id:'dj',label:'DJ',className:'zone dj',position:{x:55,y:92}},
    {id:'dessertL',label:'Postres',className:'zone dessert',position:{x:85,y:30}},
    {id:'dessertR',label:'Postres',className:'zone dessert',position:{x:85,y:70}}
  ]);
  zones.forEach(z=>{
    const el=document.createElement('div');
    el.className = z.className?.includes('zone') ? z.className : `zone ${z.className||''}`;
    el.style.left = `${isNaN(+z?.position?.x)?50:Math.min(100,Math.max(0,+z.position.x))}%`;
    el.style.top  = `${isNaN(+z?.position?.y)?50:Math.min(100,Math.max(0,+z.position.y))}%`;
    el.style.setProperty('--zone-scale', z?.scale!=null ? +z.scale : (state.cfg?.ui?.zoneScale ?? 1));
    el.textContent = z.label || z.id || '';
    map.appendChild(el);
  });

  const mesas=(state.cfg?.mesas||[]).slice().sort((a,b)=>(a.number||0)-(b.number||0));
  mesas.forEach(mm=>{
    const b=document.createElement('button');
    b.className='chair';
    b.style.left=(mm.position?.x??0)+'%';
    b.style.top =(mm.position?.y??0)+'%';
    b.textContent=mm.number||'';
    b.dataset.mesa=mm.label||`Mesa ${mm.number}`;
    b.dataset.capacity=mm.capacity||state.cfg?.defaultCapacity||10;
    b.addEventListener('click',()=>selectTable(b.dataset.mesa));
    map.appendChild(b);
  });

  $('#totMesas').textContent=mesas.length;
  $('#totCap').textContent=mesas.reduce((s,x)=>s+(x.capacity||state.cfg?.defaultCapacity||10),0);
}
function selectTable(label){
  $('#selTable').value=label; $('#tagMesa').textContent=label;
  $$('#map .chair').forEach(c=>c.classList.toggle('sel', c.dataset.mesa===label));
  updateTablePreview(); paintGuestList();
}
function getMesaCapacity(label){
  const m=(state.cfg?.mesas||[]).find(x=>(x.label||`Mesa ${x.number}`)===label);
  return m?(m.capacity||state.cfg?.defaultCapacity||10):(state.cfg?.defaultCapacity||10);
}
function updateTablePreview(){
  const label=$('#selTable').value; if(!label){$('.table-wrap').style.display='none';return;}
  $('.table-wrap').style.display='block';
  $('#tableCanvas').textContent=label;
  const cap=getMesaCapacity(label); const cont=$('#seating'); cont.innerHTML='';
  const tableSize=+getComputedStyle(document.documentElement).getPropertyValue('--table-size').replace('px','')||120;
  const seatSize =+getComputedStyle(document.documentElement).getPropertyValue('--seat-size').replace('px','')||42;
  const CX=50,CY=50,R=Math.max(28,tableSize*0.32)+seatSize*0.25;
  for(let i=1;i<=cap;i++){
    const s=document.createElement('div'); s.className='seat'; s.dataset.pos=i;
    const a=(i/cap)*2*Math.PI; s.style.left=`${CX+R*Math.cos(a)}%`; s.style.top=`${CY+R*Math.sin(a)}%`;
    cont.appendChild(s);
  }
  // ocupar
  let used=0;
  (state.guests.get(label)||[]).forEach(r=>{
    let n=1; try{const j=JSON.parse(r['JSON original']||'')||{}; n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{}
    for(let i=0;i<n;i++){ const s=cont.querySelector(`.seat[data-pos="${++used}"]`); if(s) s.classList.add('full');}
  });
}

/* Lista: solo Nombre Apellido (titulares + acompa√±antes) */
function paintGuestList(){
  const label=$('#selTable').value, box=$('#guestList'); box.innerHTML='';
  const rows=state.guests.get(label)||[]; if(!rows.length){ box.textContent='No hay invitados registrados en esta mesa.'; return; }
  rows.forEach(r=>{
    const titular=((r['Nombre']||'')+' '+(r['Apellido']||'')).trim()||'Invitado';
    box.insertAdjacentHTML('beforeend',`<div>‚Ä¢ <strong>${titular}</strong></div>`);
    try{
      const j=JSON.parse(r['JSON original']||'')||{};
      const A=Array.isArray(j.acompanantes)?j.acompanantes:[];
      A.forEach(a=>{
        const nm=[a?.nombre||'',a?.apellido||''].filter(Boolean).join(' ').trim();
        box.insertAdjacentHTML('beforeend',`<div>‚Ä¢ ${nm||'Acompa√±ante'}</div>`);
      });
    }catch{}
  });
}

/* Lectura con antiparpadeo */
function snapFor(label,map){const rows=(map.get(label)||[]);try{return JSON.stringify(rows.map(r=>`${r['Nombre']||''}|${r['Apellido']||''}|${r['JSON original']||''}`))}catch{return''}}
async function refreshGuests(silent=false){
  const prev=new Map(state.guests); const sel=$('#selTable').value; const prevSig=snapFor(sel,prev);
  let next=null;
  if(state.cfg?.guestsSheetCsvUrl){
    try{ const r=await fetch(bust(state.cfg.guestsSheetCsvUrl),{mode:'cors'}); if(r.ok){ next=csvToMap(await r.text()); }}catch{}
  }
  if(!next&&state.cfg?.reservationScriptUrl){
    try{
      const u=state.cfg.reservationScriptUrl+(state.cfg.reservationScriptUrl.includes('?')?'&':'?')+'read=1&limit=1000&_='+Date.now();
      const r=await fetch(u,{mode:'cors'}); if(r.ok){ const j=await r.json(); next=valuesToMap(Array.isArray(j?.values)?j.values:[]); }
    }catch{}
  }
  if(!next){ if(!silent) console.warn('No se pudo leer la hoja; mantengo estado anterior.'); return; }
  state.guests=next; updateChairsFull();
  const nextSig=snapFor(sel,next); if(sel && prevSig!==nextSig){ paintGuestList(); updatePreviewSeatsOnly(); }
}
function updateChairsFull(){ $$('#map .chair').forEach(ch=>{ const label=ch.dataset.mesa; const cap=+ch.dataset.capacity; const rows=state.guests.get(label)||[]; let used=0; rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} used+=n;}); ch.classList.toggle('full', used>=cap); }); }
function updatePreviewSeatsOnly(){ const label=$('#selTable').value; if(!label) return; $$('#seating .seat').forEach(s=>s.classList.remove('full')); const rows=state.guests.get(label)||[]; let used=0; rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} for(let i=0;i<n;i++){ const s=$('#seating .seat[data-pos="'+(++used)+'"]'); if(s) s.classList.add('full'); }});}

/* Parsers CSV/values */
function parseCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}else if(ch===','&&!q){out.push(cur);cur='';}else{cur+=ch}}out.push(cur);return out;}
function csvToMap(csv){if(!csv)return new Map();const lines=csv.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(x=>x.trim()!=='');if(!lines.length)return new Map();const headers=parseCSVLine(lines[0]);const normH=headers.map(h=>h.trim());const lower=normH.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const jsonI=lower.findIndex(k=>k.includes('json'));const map=new Map();for(let i=1;i<lines.length;i++){const v=parseCSVLine(lines[i]);if(v.every(x=>!x||x.trim()===''))continue;const row={};normH.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m='';if(mesaI!==-1)m=row[normH[mesaI]]||'';if(!m&&jsonI!==-1&&row[normH[jsonI]]){try{const p=JSON.parse(row[normH[jsonI]]);if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}
function valuesToMap(vals){if(!Array.isArray(vals)||!vals.length)return new Map();const headers=vals[0].map(h=>String(h||'').trim());const lower=headers.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const map=new Map();for(let i=1;i<vals.length;i++){const v=vals[i]||[];const row={};headers.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m=mesaI!==-1?String(v[mesaI]||'').trim():'';if(!m&&row['JSON original']){try{const p=JSON.parse(String(row['JSON original']));if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}

/* Duplicado por CI */
function findDuplicate(ci){
  const needle=norm(ci);
  for(const[,rows]of state.guests){
    for(const r of rows){
      const c=r['C√©dula']||r['Cedula']||''; if(norm(c)===needle){
        const info={mesa:r['Mesa']||'',menu:r['Men√∫ titular']||r['Menu titular']||'',observacion:r['Observaciones']||'',acompanantes:[]};
        try{const j=JSON.parse(r['JSON original']||'')||{}; if(Array.isArray(j.acompanantes)) info.acompanantes=j.acompanantes; if(j.mesa)info.mesa=j.mesa; if(j.menu)info.menu=j.menu; if(j.observacion)info.observacion=j.observacion;}catch{}
        return info;
      }
    }
  }
  return null;
}
function showDup(info){
  const L=[]; L.push('Mesa: '+(info.mesa||'-')); L.push('Men√∫: '+(info.menu||'-')); if(info.observacion) L.push('Obs.: '+info.observacion);
  if(Array.isArray(info.acompanantes)&&info.acompanantes.length){ L.push(''); info.acompanantes.forEach((a,i)=>{ const nm=[a?.nombre||'',a?.apellido||''].filter(Boolean).join(' ').trim(); L.push(`${i+1}. ${nm||'Acompa√±ante'}`); }); }
  $('#dupInfo').textContent=L.join('\n');
  const m=$('#dupModal'); m.style.display='flex'; m.classList.add('active');
}

/* Env√≠o */
async function send(){
  const label=$('#selTable').value; const cap=getMesaCapacity(label);
  const rows=state.guests.get(label)||[]; let used=0; rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} used+=n;});
  const acompVal=$('#acomp').value; const cnt=+(acompVal==='si'?($('#acompCount').value||0):0);
  if(!label||used+1+cnt>cap){ alert('Debe seleccionar una mesa con espacio disponible.'); return; }

  const bad2=validateScope('#scr2'); if(bad2.length){ alert('Completa:\n- '+bad2.join('\n- ')); show(2); return; }
  if(acompVal==='si'){ const bad3=validateScope('#scr3',true); if(bad3.length){ alert('Faltan datos:\n- '+bad3.join('\n- ')); show(3); return; } }

  await refreshGuests(true); const du=findDuplicate($('#ci').value); if(du){ showDup(du); return; }

  const payload=collectPayload(label);
  try{
    await sendNoCors(payload);
    const before=snapFor(label,state.guests); let ok=false; const deadline=Date.now()+20000;
    while(Date.now()<deadline){ await refreshGuests(true); if(snapFor(label,state.guests)!==before){ ok=true; break; } await new Promise(r=>setTimeout(r,1500)); }
    if(!ok){ alert('No se pudo confirmar la escritura en la hoja.'); return; }
    $('#okMesa').textContent=label; const m=$('#okModal'); m.style.display='flex'; m.classList.add('active'); stopPoll();
  }catch(e){ console.error(e); alert('Error enviando la reserva.'); }
}
function collectPayload(mesa){
  const A=[]; $$('#formAcomp input, #formAcomp select, #formAcomp textarea').forEach((el)=>{/* opcional: captar si necesitas JSON de acomp */});
  // Solo capturamos desde formAcomp en orden (nombre, apellido, cedula, menu, obs)
  const rows = $$('#formAcomp .field');
  for(let i=0;i<rows.length;i+=5){
    const nombre = rows[i+0].querySelector('input')?.value?.trim()||'';
    const apellido= rows[i+1].querySelector('input')?.value?.trim()||'';
    const cedula  = rows[i+2].querySelector('input')?.value?.trim()||'';
    const menu    = rows[i+3].querySelector('select')?.value||'';
    const obs     = rows[i+4].querySelector('textarea')?.value?.trim()||'';
    if(nombre||apellido||cedula||menu||obs) A.push({nombre,apellido,cedula,menu,observacion:obs});
  }
  return { correo:$('#email').value.trim(), grado:$('#grado').value, escalafon:$('#escalafon').value,
           nombre:$('#nombre').value.trim(), apellido:$('#apellido').value.trim(), cedula:$('#ci').value.trim(),
           menu:$('#menu').value, observacion:$('#obs').value.trim(), acompanante:$('#acomp').value,
           cantidadAcompanantes:$('#acompCount').value||($('#acomp').value==='si'?A.length:0), acompanantes:A, mesa };
}
function sendNoCors(payload){
  const url=state.cfg?.reservationScriptUrl; if(!url) return Promise.reject(new Error('Sin /exec'));
  const body=JSON.stringify({payload,submittedAt:new Date().toISOString(),...payload});
  return fetch(url,{method:'POST',mode:'no-cors',body,cache:'no-store'});
}

/* Poll & estado */
function startPoll(){ stopPoll(); state.poll=setInterval(()=>refreshGuests(true),8000); }
function stopPoll(){ if(state.poll){ clearInterval(state.poll); state.poll=null; } }
function updateChairsFull(){ $$('#map .chair').forEach(ch=>{ const label=ch.dataset.mesa; const cap=+ch.dataset.capacity; const rows=state.guests.get(label)||[]; let used=0; rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} used+=n;}); ch.classList.toggle('full', used>=cap); }); }
function updatePreviewSeatsOnly(){ const label=$('#selTable').value; if(!label) return; $$('#seating .seat').forEach(s=>s.classList.remove('full')); const rows=state.guests.get(label)||[]; let used=0; rows.forEach(r=>{let n=1;try{const j=JSON.parse(r['JSON original']||'')||{};n=1+(Array.isArray(j.acompanantes)?j.acompanantes.length:0);}catch{} for(let i=0;i<n;i++){ const s=$('#seating .seat[data-pos="'+(++used)+'"]'); if(s) s.classList.add('full'); }});}

/* Parsers */
function parseCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}else if(ch===','&&!q){out.push(cur);cur='';}else{cur+=ch}}out.push(cur);return out;}
function csvToMap(csv){if(!csv)return new Map();const lines=csv.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(x=>x.trim()!=='');if(!lines.length)return new Map();const headers=parseCSVLine(lines[0]);const normH=headers.map(h=>h.trim());const lower=normH.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const jsonI=lower.findIndex(k=>k.includes('json'));const map=new Map();for(let i=1;i<lines.length;i++){const v=parseCSVLine(lines[i]);if(v.every(x=>!x||x.trim()===''))continue;const row={};normH.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m='';if(mesaI!==-1)m=row[normH[mesaI]]||'';if(!m&&jsonI!==-1&&row[normH[jsonI]]){try{const p=JSON.parse(row[normH[jsonI]]);if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}
function valuesToMap(vals){if(!Array.isArray(vals)||!vals.length)return new Map();const headers=vals[0].map(h=>String(h||'').trim());const lower=headers.map(h=>norm(h));const mesaI=lower.findIndex(k=>['mesa','mesa n','numero','n¬∞','n'].some(c=>k===c||k.startsWith(c)));const map=new Map();for(let i=1;i<vals.length;i++){const v=vals[i]||[];const row={};headers.forEach((h,idx)=>row[h]=v[idx]==null?'':String(v[idx]).trim());let m=mesaI!==-1?String(v[mesaI]||'').trim():'';if(!m&&row['JSON original']){try{const p=JSON.parse(String(row['JSON original']));if(p&&typeof p==='object')m=p.mesa||p.Mesa||p?.payload?.mesa||'';}catch{}}if(!m)continue;if(!map.has(m))map.set(m,[]);map.get(m).push(row);}return map;}

/* Carga config & UI sizes */
async function loadConfig(){
  const local=localStorage.getItem('fiestaConfig');
  if(local){ state.cfg=JSON.parse(local); return; }
  const r=await fetch('config.json?_='+Date.now()); if(!r.ok) throw new Error('No se pudo cargar config.json'); state.cfg=await r.json();
}
function applyUiSizes(){
  const ui=state.cfg?.ui||{}; const root=document.documentElement;
  if(ui.mesaSize) root.style.setProperty('--mesa-size', `${ui.mesaSize}px`);
  if(ui.seatSize) root.style.setProperty('--seat-size', `${ui.seatSize}px`);
  if(ui.tableSize) root.style.setProperty('--table-size', `${ui.tableSize}px`);
  if(ui.zoneScale!=null) root.style.setProperty('--zone-scale', ui.zoneScale);
}

/* Eventos */
$('#btnRefresh').addEventListener('click',()=>refreshGuests().then(()=>alert('Informaci√≥n actualizada')));
$('#btnSend').addEventListener('click',e=>{e.preventDefault();send();});
$('#btnOkClose').addEventListener('click',()=>{const m=$('#okModal');m.classList.remove('active');m.style.display='none';location.reload();});
$('#btnDupClose').addEventListener('click',()=>{const m=$('#dupModal');m.classList.remove('active');m.style.display='none';});

/* Boot */
(async function init(){
  await loadConfig(); applyUiSizes(); paintHero(); show(1);
})();
</script>
</body>
</html>
