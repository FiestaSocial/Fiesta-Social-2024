<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fiesta Social 2024</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--c1:#0b66ff;--c1d:#084dcc;--c2:#f59e0b;--bg:#ffffff;--mut:#6b7280;--b:#e5e7eb;--ok:#22c55e;--err:#ef4444;--sh:0 24px 60px rgba(15,23,42,.25);--shm:0 14px 35px rgba(15,23,42,.18);--r:28px;--r2:18px;--r3:12px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;font-family:Poppins,'Segoe UI',sans-serif;background:
      radial-gradient(circle at top left,rgba(59,130,246,.45),transparent 55%),
      radial-gradient(circle at bottom right,rgba(234,179,8,.35),transparent 55%),
      linear-gradient(135deg,#0f172a,#1e293b 45%,#0f172a 90%);color:#0f172a;padding:40px 16px 60px;display:flex;justify-content:center}
    main{width:100%;max-width:1080px}
    h1,h2,h3{margin:0 0 12px}
    p{margin:0 0 16px;color:var(--mut);line-height:1.6}
    .container{background:#fff;border-radius:var(--r);padding:32px 32px 40px;box-shadow:var(--sh);display:none;margin-bottom:32px;position:relative;overflow:hidden}
    .container::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at top right,rgba(11,102,255,.08),transparent 55%);pointer-events:none}
    .container.active{display:block;animation:fade .45s ease}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .hero-card{display:grid;gap:32px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));align-items:center}
    .hero-card__eyebrow{display:inline-flex;gap:8px;padding:6px 14px;border-radius:999px;background:rgba(11,102,255,.1);color:var(--c1);font-weight:600;text-transform:uppercase;letter-spacing:.08em;font-size:12px}
    .hero-card__title{font-size:clamp(32px,5vw,48px);font-weight:700;margin-bottom:16px}
    .hero-card__description{font-size:16px;color:rgba(15,23,42,.8);margin-bottom:24px}
    .hero-card__media{border-radius:var(--r2);overflow:hidden;box-shadow:var(--shm)}
    .hero-card__media img{width:100%;display:block}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px}
    .form-field{display:flex;flex-direction:column;gap:8px}
    label{font-weight:600}
    input,select{padding:12px 14px;border-radius:var(--r3);border:1px solid var(--b);background:#f8fafc;font-size:15px}
    input:focus,select:focus{outline:none;border-color:rgba(11,102,255,.8);box-shadow:0 0 0 4px rgba(11,102,255,.12)}
    .button{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:999px;padding:12px 24px;font-weight:600;cursor:pointer}
    .button--primary{background:var(--c1);color:#fff;box-shadow:0 16px 30px rgba(11,102,255,.25)}
    .button--primary:hover{background:var(--c1d)}
    .button--ghost{background:rgba(15,23,42,.05);color:var(--c1)}
    .navigation-buttons{margin-top:32px;display:flex;gap:16px;justify-content:flex-end}
    .salon-wrapper{display:grid;grid-template-columns:260px 1fr;gap:28px;margin-bottom:32px;align-items:start}
    .salon-summary{background:rgba(248,250,252,.9);border-radius:var(--r2);padding:20px;box-shadow:0 8px 24px rgba(15,23,42,.08);position:sticky;top:32px}
    .legend{display:flex;flex-direction:column;gap:8px}
    .legend-swatch{width:16px;height:16px;border-radius:4px;display:inline-block;margin-right:8px}
    .legend .available{background:var(--c1)} .legend .full{background:var(--err)} .legend .selected{background:var(--c2)}
    .salon-map{position:relative;width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,rgba(226,232,240,.8),rgba(203,213,225,.6));border-radius:var(--r2);box-shadow:0 20px 40px rgba(15,23,42,.18);overflow:hidden}
    .map-zone{position:absolute;left:calc(var(--x,50)*1%);top:calc(var(--y,50)*1%);transform:translate(-50%,-50%);padding:6px 16px;border-radius:999px;background:rgba(15,23,42,.7);color:#fff;font-weight:600;font-size:12px}
    .map-zone--dance{background:rgba(34,197,94,.85)}
    .mesa{position:absolute;width:52px;height:52px;border-radius:16px;background:var(--c1);color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;transform:translate(-50%,-50%);border:none;cursor:pointer}
    .mesa.completa{background:var(--err)} .mesa.seleccionada{background:var(--c2)}
    .table-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:24px;margin-bottom:24px}
    .table-container{position:relative;width:100%;padding-top:100%;border-radius:var(--r2);background:rgba(248,250,252,.9);box-shadow:inset 0 0 0 1px rgba(15,23,42,.08);display:none}
    #seatsContainer{position:absolute;inset:0}
    .table{position:absolute;inset:auto;left:50%;top:50%;transform:translate(-50%,-50%);width:120px;height:120px;border-radius:50%;background:var(--c1);color:#fff;display:flex;align-items:center;justify-content:center}
    .seat{width:42px;height:42px;border-radius:12px;background:var(--ok);position:absolute;transform:translate(-50%,-50%)} .seat.occupied{background:var(--err)}
    #guestList{min-height:160px;background:rgba(248,250,252,.85);border-radius:var(--r2);padding:16px;box-shadow:inset 0 0 0 1px rgba(15,23,42,.08)}
    .tooltip{position:absolute;background:rgba(15,23,42,.88);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;display:none;z-index:50}
    .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.65);display:none;align-items:center;justify-content:center;padding:24px;z-index:100}
    .modal-overlay.active{display:flex}
    .modal-content{background:#fff;border-radius:24px;padding:32px;max-width:420px;text-align:center;box-shadow:var(--sh)}
    @media(max-width:900px){body{padding:24px 12px 48px}.salon-wrapper{grid-template-columns:1fr}}
  </style>
</head>
<body>
<main>
  <section id="screen1" class="container active">
    <div class="hero-card" id="heroCard"></div>
  </section>

  <section id="screen2" class="container">
    <h2>Datos personales</h2>
    <p>Completa tus datos para asegurar tu lugar.</p>
    <form id="guestForm" class="form-grid" autocomplete="on">
      <div class="form-field"><label for="correo">Correo</label><input id="correo" name="correo" type="email" required></div>
      <div class="form-field"><label for="grado">Grado</label>
        <select id="grado" name="grado" required>
          <option value="" selected>Seleccionar</option><option>Cnel.</option><option>Tte. Cnel.</option><option>May.</option><option>Cap.</option><option>Tte. 1°</option><option>Tte. 2°</option><option>Alf.</option>
        </select>
      </div>
      <div class="form-field"><label for="escalafon">Escalafón</label>
        <select id="escalafon" name="escalafon" required>
          <option value="" selected>Seleccionar</option><option>(Av.)</option><option>(Nav.)</option><option>(Esp.)</option><option>(T.P.)</option>
        </select>
      </div>
      <div class="form-field"><label for="nombre">Nombre</label><input id="nombre" name="nombre" required></div>
      <div class="form-field"><label for="apellido">Apellido</label><input id="apellido" name="apellido" required></div>
      <div class="form-field"><label for="cedula">Cédula (0.000.000-0)</label><input id="cedula" name="cedula" required pattern="^\d\.\d{3}\.\d{3}-\d$"></div>
      <div class="form-field"><label for="acompanante">¿Asiste con acompañante?</label>
        <select id="acompanante" name="acompanante" required><option value="" selected>Seleccionar</option><option value="no">No</option><option value="si">Sí</option></select>
      </div>
      <div class="form-field" id="acompananteCantidad" style="display:none;">
        <label for="cantidadAcompanantes">¿Cuántos acompañantes?</label>
        <select id="cantidadAcompanantes" name="cantidadAcompanantes">
          <option value="" selected>Seleccionar</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
      </div>
      <div class="form-field"><label for="menu">Menú</label>
        <select id="menu" name="menu" required>
          <option value="" selected>Seleccionar</option><option value="normal">Normal</option><option value="vegetariano">Vegetariano</option><option value="vegano">Vegano</option><option value="celiaco">Celíaco</option>
        </select>
      </div>
      <input type="hidden" id="mesa" name="mesa">
    </form>
    <div class="navigation-buttons">
      <button class="button button--ghost" data-prev="1">Anterior</button>
      <button class="button button--primary" data-next>Continuar</button>
    </div>
  </section>

  <section id="screen3" class="container">
    <h2>Información de acompañantes</h2>
    <form id="acompanantesForm"></form>
    <div class="navigation-buttons">
      <button class="button button--ghost" data-prev="2">Anterior</button>
      <button class="button button--primary" data-next="4">Continuar</button>
    </div>
  </section>

  <section id="screen4" class="container">
    <h2>Selecciona tu mesa</h2>
    <div class="salon-wrapper">
      <aside class="salon-summary">
        <h3>Resumen del salón</h3>
        <p><strong>Mesas:</strong> <span id="totalMesasCounter">--</span></p>
        <p><strong>Capacidad total:</strong> <span id="capacidadTotalCounter">--</span></p>
        <p><strong>Mesa seleccionada:</strong> <span id="mesaSeleccionadaLabel">Sin seleccionar</span></p>
        <div class="legend">
          <span><span class="legend-swatch available"></span>Disponible</span>
          <span><span class="legend-swatch full"></span>Completa</span>
          <span><span class="legend-swatch selected"></span>Seleccionada</span>
        </div>
      </aside>
      <div id="salonMap" class="salon-map"></div>
    </div>

    <div class="table-details">
      <div class="table-container">
        <div class="table" id="mesaText">Mesa</div>
        <div id="seatsContainer"></div>
      </div>
      <div>
        <h3>Invitados registrados en esta mesa</h3>
        <div id="guestList">Selecciona una mesa para ver los invitados.</div>
      </div>
    </div>

    <div class="navigation-buttons">
      <button class="button button--ghost" data-prev="3">Anterior</button>
      <button id="submitReservationBtn" class="button button--primary">Enviar</button>
    </div>
  </section>
</main>

<div id="confirmationModal" class="modal-overlay">
  <div class="modal-content">
    <h2>Registro completo</h2>
    <p>Tu reserva se guardó en <strong id="mesaConfirmada"></strong>. Si deseas realizar un cambio, comunícate con la Sec. Contable de la B.A. III.</p>
    <button class="button button--primary" id="finalizarBtn">Finalizar</button>
  </div>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
/* ---------- Texto héroe ---------- */
const HERO_CARD_TEMPLATE = `
  <div>
    <span class="hero-card__eyebrow" id="siteSubtitle">Registro oficial de invitados</span>
    <h1 class="hero-card__title" id="siteTitleHeading">Fiesta Social 2024</h1>
    <p class="hero-card__description" id="siteDescription">Confirma tu asistencia, elige tu menú y selecciona tu mesa favorita.</p>
    <div class="hero-card__actions">
      <button class="button button--primary" data-next="2">Comenzar registro</button>
      <a class="button button--ghost" href="admin.html">Administración</a>
    </div>
  </div>
  <figure class="hero-card__media"><img id="heroImage" src="Imagen de bienvenida.png" alt=""></figure>
`;

/* ---------- Config/estado ---------- */
const DEFAULT_RESERVATION_ENDPOINT = ''; // se toma de config.json
const DEFAULT_GUESTS_SHEET_CSV_URL = ''; // opcional
const DEFAULT_ZONES = [
  { id:'dance', label:'Pista de baile', className:'map-zone map-zone--dance', position:{x:50,y:45} },
  { id:'stage', label:'Estado Mayor',   className:'map-zone',                 position:{x:6, y:50} },
  { id:'entrance', label:'Entrada / Piscina', className:'map-zone',           position:{x:50,y:6} },
  { id:'dj', label:'DJ', className:'map-zone', position:{x:50,y:94} }
];

const state = {
  currentScreen: 1,
  siteConfig: null,
  reservationEndpoint: DEFAULT_RESERVATION_ENDPOINT,
  guestsSheetUrl: DEFAULT_GUESTS_SHEET_CSV_URL,
  guestsByTable: new Map(),
  fetchInterval: null,
  selectedTable: null
};

const dom = {
  heroCard: document.getElementById('heroCard'),
  salonMap: document.getElementById('salonMap'),
  guestForm: document.getElementById('guestForm'),
  acompanantesForm: document.getElementById('acompanantesForm'),
  mesaInput: document.getElementById('mesa'),
  mesaText: document.getElementById('mesaText'),
  mesaSeleccionadaLabel: document.getElementById('mesaSeleccionadaLabel'),
  seatsContainer: document.getElementById('seatsContainer'),
  guestList: document.getElementById('guestList'),
  totalMesasCounter: document.getElementById('totalMesasCounter'),
  capacidadTotalCounter: document.getElementById('capacidadTotalCounter'),
  tooltip: document.getElementById('tooltip'),
  submitButton: document.getElementById('submitReservationBtn'),
  modal: document.getElementById('confirmationModal'),
  mesaConfirmada: document.getElementById('mesaConfirmada'),
  finalizarBtn: document.getElementById('finalizarBtn')
};

/* ---------- Utilidades ---------- */
const norm = s => (s==null? '' : String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim());
const buster = u => !u ? '' : u + (u.includes('?')?'&':'?') + '_=' + Date.now();

/* ---------- Navegación ---------- */
function ensureHero(){ dom.heroCard.innerHTML = HERO_CARD_TEMPLATE; }
function firstScreen(){ document.querySelectorAll('.container').forEach((s,i)=> s.classList.toggle('active', i===0)); state.currentScreen=1; }
function showScreen(n){
  if(!n || n===state.currentScreen) return;
  document.getElementById(`screen${state.currentScreen}`)?.classList.remove('active');
  state.currentScreen = n;
  document.getElementById(`screen${state.currentScreen}`)?.classList.add('active');
  if (state.currentScreen === 4) { fetchGuestsData().catch(()=>{}); startGuestsPolling(); }
  else { stopGuestsPolling(); }
}
function validateForm(id){
  const f=document.getElementById(id); if(!f) return [];
  const bad=[]; f.querySelectorAll('input,select').forEach(el=>{
    if(!el.checkValidity()){ const lab=f.querySelector(`label[for="${el.id}"]`); bad.push((lab?lab.textContent:el.name||el.id).replace(':','').trim()); }
  }); return bad;
}
function handleNav(e){
  const next=e.target.closest('[data-next]'); const prev=e.target.closest('[data-prev]'); if(!next&&!prev) return;
  e.preventDefault();
  if(prev){ showScreen(parseInt(prev.dataset.prev,10)||Math.max(1,state.currentScreen-1)); return; }
  if(state.currentScreen===2){
    const bad=validateForm('guestForm'); if(bad.length){ alert('Completa: \n- '+bad.join('\n- ')); return; }
    const a=document.getElementById('acompanante').value;
    if(a==='si'){ const cant=document.getElementById('cantidadAcompanantes').value; if(!cant){ alert('Selecciona la cantidad de acompañantes.'); return; } renderAcompanantes(parseInt(cant,10)); showScreen(3); return; }
    showScreen(4); return;
  }
  if(state.currentScreen===3){
    const bad=validateForm('acompanantesForm'); if(bad.length){ alert('Faltan datos de acompañantes:\n- '+bad.join('\n- ')); return; }
    showScreen(4); return;
  }
  showScreen(parseInt(next.dataset.next,10)||state.currentScreen+1);
}
function toggleAcomp(){
  const a=document.getElementById('acompanante').value, box=document.getElementById('acompananteCantidad'), sel=document.getElementById('cantidadAcompanantes');
  if(a==='si'){ box.style.display='block'; sel.required=true; } else { box.style.display='none'; sel.required=false; sel.value=''; dom.acompanantesForm.innerHTML=''; }
}
function renderAcompanantes(n){
  dom.acompanantesForm.innerHTML='';
  for(let i=1;i<=n;i++){
    dom.acompanantesForm.insertAdjacentHTML('beforeend',`
      <div class="form-grid">
        <div class="form-field">
          <h3>Acompañante ${i}</h3>
          <label for="nombreAcompanante${i}">Nombre</label>
          <input id="nombreAcompanante${i}" name="nombreAcompanante${i}" required>
        </div>
        <div class="form-field">
          <label for="menuAcompanante${i}">Menú</label>
          <select id="menuAcompanante${i}" name="menuAcompanante${i}" required>
            <option value="" selected>Seleccionar</option>
            <option value="normal">Normal</option><option value="vegetariano">Vegetariano</option><option value="vegano">Vegano</option><option value="celiaco">Celíaco</option>
          </select>
        </div>
      </div>`);
  }
}

/* ---------- Plano ---------- */
function renderZones(zones){
  dom.salonMap.querySelectorAll('.map-zone').forEach(x=>x.remove());
  const items = Array.isArray(zones)&&zones.length ? zones : DEFAULT_ZONES;
  items.forEach(z=>{
    const el=document.createElement('div');
    el.className = z.className || 'map-zone';
    el.textContent = z.label || '';
    el.style.setProperty('--x', z.position?.x ?? 50);
    el.style.setProperty('--y', z.position?.y ?? 50);
    dom.salonMap.appendChild(el);
  });
}
function renderTables(mesas){
  dom.salonMap.querySelectorAll('.mesa').forEach(x=>x.remove());
  (mesas||[]).forEach(m=>{
    const b=document.createElement('button');
    b.type='button'; b.className='mesa'; const label=m.label||`Mesa ${m.number}`;
    b.dataset.label = label; b.dataset.capacity = m.capacity ?? state.siteConfig?.defaultCapacity ?? 10;
    b.style.left = (m.position?.x ?? 0) + '%'; b.style.top = (m.position?.y ?? 0) + '%';
    b.textContent = m.number ?? label;
    b.addEventListener('click',()=>selectTable(label));
    dom.salonMap.appendChild(b);
  });
  colorMesas();
}
function selectTable(label){
  state.selectedTable=label; dom.mesaInput.value=label;
  document.querySelectorAll('.mesa').forEach(m=>m.classList.toggle('seleccionada', m.dataset.label===label));
  dom.mesaSeleccionadaLabel.textContent=label;
  document.querySelector('.table-container').style.display='block';
  updateMesaPreview();
}
function getMesaCapacity(label){
  const m=(state.siteConfig?.mesas||[]).find(x=>(x.label||`Mesa ${x.number}`)===label);
  return (m && typeof m.capacity==='number') ? m.capacity : (state.siteConfig?.defaultCapacity||10);
}
function invitadosDeMesa(label){
  if(!label) return [];
  if (state.guestsByTable.has(label)) return state.guestsByTable.get(label)||[];
  const nl = norm(label); for(const [k,v] of state.guestsByTable.entries()){ if(norm(k)===nl) return v; }
  return [];
}
function updateMesaPreview(){
  const label = dom.mesaInput.value; if(!label) return;
  dom.mesaText.textContent = label; pintarAsientos(); listarInvitados();
}
function pintarAsientos(){
  const label=dom.mesaInput.value, cap=getMesaCapacity(label), cont=dom.seatsContainer;
  cont.innerHTML=''; for(let i=1;i<=cap;i++){const s=document.createElement('div');s.className='seat';s.dataset.seat=i;cont.appendChild(s)}
  const seats=cont.querySelectorAll('.seat'), CX=50,CY=50,R=38;
  seats.forEach((s,i)=>{const a=(i/seats.length)*2*Math.PI; s.style.left=`${CX+R*Math.cos(a)}%`; s.style.top=`${CY+R*Math.sin(a)}%`});
  let taken=0; invitadosDeMesa(label).forEach(g=>{const n=1+(Array.isArray(g.acompanantes)?g.acompanantes.length:0); for(let i=0;i<n;i++){ if(taken<cap){cont.querySelector(`.seat[data-seat="${++taken}"]`)?.classList.add('occupied');}}});
}
function listarInvitados(){
  const el=dom.guestList, label=dom.mesaInput.value; el.innerHTML='';
  const guests=invitadosDeMesa(label);
  if(!guests.length){ el.textContent='No hay invitados registrados en esta mesa.'; return; }
  guests.forEach(g=>{
    const full = [g['Nombre']||g.nombre,g['Apellido']||g.apellido].filter(Boolean).join(' ') || 'Invitado';
    const row = document.createElement('div'); row.innerHTML = `<strong>${full}</strong>`; el.appendChild(row);
    const acomp = Array.isArray(g.acompanantes)?g.acompanantes:[]; acomp.forEach(a=>{const d=document.createElement('div'); d.textContent = a?.nombre || a; el.appendChild(d);});
  });
}
function colorMesas(){
  document.querySelectorAll('.mesa').forEach(m=>m.classList.remove('completa'));
  state.guestsByTable.forEach((arr,label)=>{
    const cap=getMesaCapacity(label);
    const total = arr.reduce((s,g)=> s + 1 + (Array.isArray(g.acompanantes)?g.acompanantes.length:0), 0);
    if(total>=cap){
      document.querySelectorAll('.mesa').forEach(b=>{ if(norm(b.dataset.label)===norm(label)) b.classList.add('completa'); });
    }
  });
}

/* ---------- Polling / lectura ---------- */
function stopGuestsPolling(){ if(state.fetchInterval){ clearInterval(state.fetchInterval); state.fetchInterval=null; } }
function startGuestsPolling(){ stopGuestsPolling(); state.fetchInterval=setInterval(()=>{fetchGuestsData().catch(()=>{})},5000); }

function parseCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const c=line[i];if(c==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;} else if(c===','&&!q){out.push(cur);cur='';} else cur+=c;} out.push(cur); return out;}
function csvToMap(csv){
  if(!csv) return new Map(); const lines=csv.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim()!==''); if(!lines.length) return new Map();
  const headers=parseCSVLine(lines[0]); const normH=headers.map(h=>h.trim()); const lower=normH.map(h=>norm(h));
  const mesaKeys=['mesa','mesa n','mesa n°','n','n°','numero','número']; let mesaIdx=-1; for(let i=0;i<lower.length;i++){const k=lower[i]; if(mesaKeys.some(c=>k===c||k.startsWith(c))){mesaIdx=i;break}}
  const jsonIdx=lower.findIndex(k=>k.includes('json')); const map=new Map();
  for(let i=1;i<lines.length;i++){
    const v=parseCSVLine(lines[i]); if(v.every(x=>!x||x.trim()==='')) continue;
    const e={}; normH.forEach((h,idx)=> e[h]=v[idx]==null?'':String(v[idx]).trim());
    if(jsonIdx!==-1){const raw=v[jsonIdx]; try{const p=JSON.parse(raw); if(p&&typeof p==='object'){e.__parsedJson=p; if(!e.mesa && (p.mesa||p.Mesa||p?.payload?.mesa)) e.mesa = p.mesa||p.Mesa||p.payload.mesa;}}catch{}}
    const mesa = String(e.mesa || e['Mesa'] || '').trim(); if(!mesa) continue;
    if(!map.has(mesa)) map.set(mesa,[]); map.get(mesa).push(e);
  } return map;
}
function valuesToMap(values){
  if(!Array.isArray(values)||!values.length) return new Map();
  const headers=values[0].map(h=>String(h||'').trim()); const lower=headers.map(h=>norm(h)); const map=new Map();
  let mesaIdx = lower.findIndex(k=>['mesa','mesa n','mesa n°','n','n°','numero','número'].some(c=>k===c||k.startsWith(c)));
  const jsonIdx = lower.findIndex(k=>k.includes('json'));
  for(let i=1;i<values.length;i++){
    const row=values[i]||[]; const e={}; headers.forEach((h,idx)=> e[h]=row[idx]==null?'':String(row[idx]).trim());
    let mesa = mesaIdx!==-1 ? String(row[mesaIdx]||'').trim() : '';
    if(!mesa && jsonIdx!==-1 && row[jsonIdx]){ try{const p=JSON.parse(String(row[jsonIdx])); if(p&&typeof p==='object'){e.__parsedJson=p; mesa = p.mesa||p.Mesa||p?.payload?.mesa||'';}}catch{} }
    if(!mesa) continue; if(!map.has(mesa)) map.set(mesa,[]); map.get(mesa).push(e);
  } return map;
}
async function fetchGuestsData(){
  // 1) CSV publicado (si existe)
  if(state.guestsSheetUrl){
    try{
      const res=await fetch(buster(state.guestsSheetUrl),{method:'GET',mode:'cors',cache:'no-store'});
      if(res.ok){ const text=await res.text(); const m=csvToMap(text); if(m.size){ state.guestsByTable=m; colorMesas(); listarInvitados(); pintarAsientos(); return m; } }
    }catch{}
  }
  // 2) Fallback Apps Script ?read=1
  if(state.reservationEndpoint){
    try{
      const url=state.reservationEndpoint + (state.reservationEndpoint.includes('?')?'&':'?') + 'read=1&limit=1000&_=' + Date.now();
      const r=await fetch(url,{method:'GET',mode:'cors',cache:'no-store'}); if(r.ok){ const payload=await r.json().catch(()=>({})); const values=Array.isArray(payload?.values)?payload.values:[]; const m=valuesToMap(values); state.guestsByTable=m; colorMesas(); listarInvitados(); pintarAsientos(); return m; }
    }catch{}
  }
  state.guestsByTable=new Map(); colorMesas(); listarInvitados(); pintarAsientos(); return state.guestsByTable;
}

/* ---------- Envío + confirmación real ---------- */
function setBtnSending(b){ if(!dom.submitButton) return; dom.submitButton.disabled=b; dom.submitButton.textContent=b?'Enviando...':'Enviar'; }
function fingerprint(d){ return norm(d.cedula)+'|'+norm(d.correo)+'|'+norm((d.nombre||'')+' '+(d.apellido||'')); }
function mesaSnapshot(label){ const arr=invitadosDeMesa(label); const map=new Map(); (arr||[]).forEach(g=>{ const key = norm((g['Cédula']||g['Cedula']||g.cedula||''))+'|'+norm((g['Correo']||g.correo||''))+'|'+norm(((g['Nombre']||g.nombre||'')+' '+(g['Apellido']||g.apellido||''))); map.set(key,(map.get(key)||0)+1); }); return map; }
function snapshotHasNew(prev, now){ for(const [k,c] of now.entries()){ if((prev.get(k)||0) < c) return true; } return false; }

async function sendNoCors(url, body){ await fetch(url,{method:'POST',mode:'no-cors',body,cache:'no-store'}); }

async function submitReservation(url, payload){
  const body = JSON.stringify({ payload, submittedAt: new Date().toISOString(), ...payload });
  // 1) estado base de la mesa
  await fetchGuestsData().catch(()=>{});
  const base = mesaSnapshot(payload.mesa);

  // 2) envío
  try{ await sendNoCors(url, body); }
  catch(e){
    // fallback GET si el POST falla
    const qs = new URLSearchParams({ ...payload, submittedAt: new Date().toISOString() });
    await fetch(url+(url.includes('?')?'&':'?')+qs.toString(), {method:'GET',mode:'no-cors'}).catch(()=>{});
  }

  // 3) verificar aparición del registro (hasta ~20s)
  const deadline = Date.now()+20000;
  while(Date.now()<deadline){
    await new Promise(r=>setTimeout(r,2000));
    await fetchGuestsData().catch(()=>{});
    const now = mesaSnapshot(payload.mesa);
    if(snapshotHasNew(base, now)) return true;
  }
  throw new Error('no_confirmed');
}

async function onSubmit(e){
  e.preventDefault();
  const mesa=dom.mesaInput.value;
  const cap=getMesaCapacity(mesa);
  const ocupados = invitadosDeMesa(mesa).reduce((s,g)=> s + 1 + (Array.isArray(g.acompanantes)?g.acompanantes.length:0), 0);
  const cant = parseInt(document.getElementById('cantidadAcompanantes').value||'0',10)||0;
  if(!mesa || ocupados+1+cant>cap){ alert('Debe seleccionar una mesa con espacio disponible.'); return; }
  if(!(dom.guestForm.checkValidity() && dom.acompanantesForm.checkValidity())){ alert('Complete todos los campos requeridos.'); return; }

  // armar payload
  const fd1 = new FormData(dom.guestForm), fd2 = new FormData(dom.acompanantesForm);
  const acomp=[]; fd2.forEach((v,k)=>{const i=parseInt(k.replace(/\D/g,''),10)-1; if(k.includes('nombreAcompanante')){ (acomp[i]??={}).nombre=v; } else if(k.includes('menuAcompanante')){ (acomp[i]??={}).menu=v; }});
  const data = { correo:fd1.get('correo'), grado:fd1.get('grado'), escalafon:fd1.get('escalafon'), nombre:fd1.get('nombre'),
                 apellido:fd1.get('apellido'), cedula:fd1.get('cedula'), acompanante:fd1.get('acompanante'),
                 cantidadAcompanantes:fd1.get('cantidadAcompanantes'), menu:fd1.get('menu'), acompanantes:acomp, mesa };

  if(!state.reservationEndpoint){ alert('Falta la URL del Apps Script. Configúrala en admin.html.'); return; }

  setBtnSending(true);
  try{
    await submitReservation(state.reservationEndpoint, data);
    stopGuestsPolling();
    dom.mesaConfirmada.textContent = mesa;
    dom.modal.classList.add('active'); dom.modal.style.display='flex';
  }catch(err){
    console.error(err);
    alert('No se pudo confirmar la escritura en la hoja. Revisa el Apps Script / permisos / SHEET_ID.');
  }finally{ setBtnSending(false); }
}

/* ---------- Config ---------- */
async function loadConfig(){
  try{ const local=localStorage.getItem('fiestaConfig'); if(local) return JSON.parse(local); }catch{}
  const r=await fetch('config.json?_='+Date.now()); if(!r.ok) throw new Error('No se pudo cargar config.json'); return await r.json();
}
function applyConfig(cfg){
  state.siteConfig = cfg||{};
  state.reservationEndpoint = cfg.reservationScriptUrl || DEFAULT_RESERVATION_ENDPOINT;
  state.guestsSheetUrl = cfg.guestsSheetCsvUrl || DEFAULT_GUESTS_SHEET_CSV_URL;

  document.title = cfg.siteTitle || document.title;
  ensureHero();
  if(cfg.siteTitle) document.getElementById('siteTitleHeading').textContent = cfg.siteTitle;
  if(cfg.siteSubtitle) document.getElementById('siteSubtitle').textContent = cfg.siteSubtitle;
  if(cfg.siteDescription) document.getElementById('siteDescription').textContent = cfg.siteDescription;
  if(cfg.heroImage) document.getElementById('heroImage').src = cfg.heroImage;

  const mesas = Array.isArray(cfg.mesas)? [...cfg.mesas].sort((a,b)=>(a.number||0)-(b.number||0)) : [];
  renderZones(cfg.zones); renderTables(mesas);
  dom.totalMesasCounter.textContent = mesas.length;
  dom.capacidadTotalCounter.textContent = mesas.reduce((s,m)=> s+(m.capacity||cfg.defaultCapacity||10), 0);
  fetchGuestsData().catch(()=>{});
}

/* ---------- Eventos ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  firstScreen(); ensureHero();
  document.body.addEventListener('click', handleNav);
  document.getElementById('acompanante').addEventListener('change', toggleAcomp);
  dom.submitButton.addEventListener('click', onSubmit);
  dom.finalizarBtn.addEventListener('click', ()=>location.reload());
  try{ const cfg = await loadConfig(); applyConfig(cfg); }catch(e){ console.error(e); alert('No se pudo cargar la configuración.'); }
});
</script>
</body>
</html>
